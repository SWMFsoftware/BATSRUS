# ^CFG FILE TESTING

### TESTS FOR THE STAND-ALONE BATSRUS ###

# Setting BLESS=YES or Y will copy the solution into the reference solution
BLESS=NO

DIFFNUM = ${SCRIPTDIR}/DiffNum.pl -BLESS=${BLESS}

.NOTPARALLEL:

test_help:
	@echo "    test                       (run tests with ${OMPIRUN})"
	@echo "    test NP=3 NTHREAD=4        (run tests with ${PARALLEL} -n 3 and 4 threads)"
	@echo "    test NP='8 --oversubscribe'(run tests with ${PARALLEL} -n 8 --oversubscribe)"
	@echo "    test PARALLEL=aprun        (run tests with aprun instead of mpiexec)"
	@echo "    test NPFLAG=-np            (run tests with -np instead of -n)"
	@echo "    test MPIRUN=               (run tests without MPI)"
	@echo "    test OPENMP=-noopenmp      (run tests without OpenMP)"
	@echo "    test OPENACC=-noacc        (run tests without OpenACC)"
	@echo ""
	@echo "    test_gpu                   (run GPU related tests only)"
	@echo "    test_small_gpu             (run small GPU tests only)"
	@echo ""
	@echo "    test_amr_compile           (compile test_amr)"
	@echo "    test_amr_rundir            (create run directory for test_amr)"
	@echo "    test_amr_run NP=4          (run test_amr with 4 MPI processes)"
	@echo "    test_amr_check             (check test_amr results against reference)"
	@echo "    test_amr_check BLESS=YES   (update test_amr reference solutions)"
	@echo "    test_amr TESTDIR=run_amr   (run AMR test in run_amr directory)"
	@echo ""
	@echo "    test_2bodyplot             (run 2 Body Plot test)"  
	@echo "    test_amr                   (run Cartesian AMR test)"
	@echo "    test_amrsph                (run spherical AMR test)"
	@echo "    test_moonimpact            (run moon impact test)"
	@echo "    test_anisotropic           (run anisotropic pressure test)"
	@echo "    test_awsom                 (run AWSoM corona test)"
	@echo "    test_awsom_bvector         (run AWSoM with vector B field)"
	@echo "    test_awsom_gpu             (run AWSoM corona test on GPU)"
	@echo "    test_awsom_large_gpu       (run large AWSoM corona test on GPU)"
	@echo "    test_awsomr                (run AWSoM-R corona test)"
	@echo "    test_bvector               (run Bvector Solar Corona test)"
	@echo "    test_bx0                   (run 3D bx0 isosurface plot test)"
	@echo "    test_comet                 (run comet test)"
	@echo "    test_cometCGhd             (run comet CG hd test)"
	@echo "    test_cometCGfluids         (run comet CG fluids test)"
	@echo "    test_earth                 (run small Earth test for GPU)"
	@echo "    test_earth_large_gpu       (run large Earth test for GPU)"
	@echo "    test_earthsph              (run spherical Earth test)"
	@echo "    test_fastwave              (run 3D fast wave test on GPU)"
	@echo "    test_fastwave_2d           (run 2D rotated fast wave test on GPU)"
	@echo "    test_fivemoment_alfven     (run 5-moment Alven wave test)"
	@echo "    test_fivemoment_shock      (run 5-moment shock wave test)"
	@echo "    test_fivemoment_langmuir   (run 5-moment Langmuir wave test)"
	@echo "    test_fluxemergence         (run flux emergence test)"
	@echo "    test_hallmhd               (run Hall MHD test)"
	@echo "    test_jupiter               (run Jupiter test)"
	@echo "    test_L1toBC                (run L1 to BC propagation test)"
	@echo "    test_magnetometer          (run magnetometer test)"
	@echo "    test_mars                  (run Mars test)"
	@echo "    test_mars_start            (run first Mars test)"
	@echo "    test_mars_restart          (run Mars restart test)"
	@echo "    test_marsfluids            (run Mars multifluid test)"
	@echo "    test_ccmc_mars             (run Mars for CCMC test)"
	@echo "    test_mercurysph            (run Mercury test)"
	@echo "    test_mhdnoncons            (run non-conservative MHD test)"
	@echo "    test_multifluid            (run multi-fluid test)"
	@echo "    test_multiion              (run multi-ion test)"
	@echo "    test_partsteady            (run part steady test)"
	@echo "    test_region2d              (run 2D BATL region test)"
	@echo "    test_saturn                (run Saturn test)"
	@echo "    test_shockramp             (run shockramp test)"
	@echo "    test_shockround            (run shocktube test on roundcube)"
	@echo "    test_shocktube             (run shocktube test)"
	@echo "    test_shocktube_1d          (run 1D shocktube test on GPU)"
	@echo "    test_stitch                (run STITCH test)"
	@echo "    test_timewarp_1d           (run 1D time warp test)"
	@echo "    test_timewarp_2d           (run 2D time warp test)"
	@echo "    test_outerhelio2d          (run 2D Outer Heliosphere test)"
	@echo "    test_outerhelio            (run Outer Heliosphere test)"
	@echo "    test_outerhelio_1d         (run 1D Outer Heliosphere test)"
	@echo "    test_outerhelioawsom       (run Outer Heliosphere w/ Turb test)"
	@echo "    test_outerheliopui         (run Outer Heliosphere w/ PUIs test)"
	@echo "    test_outerheliopui_1d      (run 1D Outer Heliosphere w/ PUIs test)"
	@echo "    test_spectrum              (run spectrum post-processing test)"
	@echo "    test_titan                 (run Titan tests)"
	@echo "    test_titan_start           (run first Titan test)"
	@echo "    test_titan_restart         (run titan restart test)"
	@echo "    test_twofluidmhd           (run two-fluid test)"
	@echo "    test_venus                 (run Venus test)"
	@echo "    test_viscosity             (run viscosity test)"
	-@(if [ -d srcUserExtra ]; then ${MAKE} test_extra_help; fi)

test_extra_help:
	@echo "    test_awsomchargestate      (run corona with charge state test)"
	@echo "    test_eosgodunov            (run EOS/Godunov test)"
	@echo "    test_europa2fluidspe       (run 2-ion-fluid+Pe Europa test)"
	@echo "    test_europa3fluidspe       (run 3-ion-fluid+Pe Europa test)"
	@echo "    test_ganymede              (run Ganymede test)"
	@echo "    test_graydiffusion         (run gray-diffusion set test)"
	@echo "    test_laserpackage          (run CRASH laser package test)"

test: 
	@rm -f *.diff
	-@($(MAKE) test_spectrum)
	-@($(MAKE) test_small_gpu)
	cd ${DIR}; ./Config.pl -noacc
	-@($(MAKE) test_bx0 TESTDIR=run_test_bx0)
	-@($(MAKE) test_shocktube TESTDIR=run_test_shocktube)
	-@($(MAKE) test_shockround TESTDIR=run_test_shockround)
	-@($(MAKE) test_timewarp_1d TESTDIR=run_test_timewarp_1d)
	-@($(MAKE) test_timewarp_2d TESTDIR=run_test_timewarp_2d)
	-@($(MAKE) test_shockramp TESTDIR=run_test_shockramp)
	-@($(MAKE) test_partsteady TESTDIR=run_test_partsteady)
	-@($(MAKE) test_hallmhd TESTDIR=run_test_hallmhd)
	-@($(MAKE) test_twofluidmhd TESTDIR=run_test_twofluidmhd)
	-@($(MAKE) test_multifluid TESTDIR=run_test_multifluid)
	-@($(MAKE) test_multiion TESTDIR=run_test_multiion)
	-@($(MAKE) test_mhdnoncons TESTDIR=run_test_mhdnoncons)
	-@($(MAKE) test_viscosity TESTDIR=run_test_viscosity)
	-@($(MAKE) test_awsom TESTDIR=run_test_awsom)
	-@($(MAKE) test_awsomr TESTDIR=run_test_awsomr)
	-@($(MAKE) test_stitch TESTDIR=run_test_stitch)
	-@($(MAKE) test_earthsph TESTDIR=run_test_earthsph)
	-@($(MAKE) test_2bodyplot TESTDIR=run_test_2bodyplot)
	-@($(MAKE) test_magnetometer TESTDIR=run_test_magnetometer)
	-@($(MAKE) test_anisotropic TESTDIR=run_test_anisotropic)
	-@($(MAKE) test_region2d TESTDIR=run_test_region2d)
	-@($(MAKE) test_fivemoment_alfven TESTDIR=run_test_fivemoment_alfven)
	-@($(MAKE) test_fivemoment_shock TESTDIR=run_test_fivemoment_shock)
	-@($(MAKE) test_fivemoment_langmuir TESTDIR=run_test_fivemoment_langmuir)
	-@($(MAKE) test_outerhelio2d TESTDIR=run_test_outerhelio2d)
	-@($(MAKE) test_outerhelio TESTDIR=run_test_outerhelio)
	-@($(MAKE) test_outerhelio_1d TESTDIR=run_test_outerhelio_1d)
	-@($(MAKE) test_outerhelioawsom TESTDIR=run_test_outerhelioawsom)
	-@($(MAKE) test_outerheliopui TESTDIR=run_test_outerheliopui)
	-@($(MAKE) test_outerheliopui_1d TESTDIR=run_test_outerheliopui_1d)
	-@($(MAKE) test_moonimpact TESTDIR=run_test_moonimpact)
	-@($(MAKE) test_comet TESTDIR=run_test_comet)
	-@($(MAKE) test_cometCGhd TESTDIR=run_test_cometCGhd)
	-@($(MAKE) test_cometCGfluids TESTDIR=run_test_cometCGfluids)
	-@($(MAKE) test_mars TESTDIR=run_test_mars)
	-@($(MAKE) test_ccmc_mars TESTDIR=run_test_ccmc_mars)
	-@($(MAKE) test_mercurysph TESTDIR=run_test_mercurysph)
	-@($(MAKE) test_saturn TESTDIR=run_test_saturn)
	-@($(MAKE) test_jupiter TESTDIR=run_test_jupiter)
	-@($(MAKE) test_titan TESTDIR=run_test_titan)
	-@($(MAKE) test_venus TESTDIR=run_test_venus)
	-@(if [ -d srcUserExtra ]; then ${MAKE} test_extra; fi)
	./Config.pl -noopenmp
	@ls -l *.diff

test_small_gpu:
	-@($(MAKE) test_shocktube_1d TESTDIR=run_test_shocktube_1d)
	-@($(MAKE) test_fastwave TESTDIR=run_test_fastwave)
	-@($(MAKE) test_fastwave_2d TESTDIR=run_test_fastwave_2d)
	-@($(MAKE) test_earth TESTDIR=run_test_earth)
	-@($(MAKE) test_awsom_gpu TESTDIR=run_test_awsom_gpu)
	-@($(MAKE) test_heatcond_2d TESTDIR=run_test_heatcond_2d)

test_gpu: test_small_gpu
	-@($(MAKE) test_awsom_large_gpu TESTDIR=run_test_awsom_large_gpu)
	-@($(MAKE) test_earth_large_gpu TESTDIR=run_test_earth_large_gpu)

test_extra:
	-@($(MAKE) test_awsomchargestate TESTDIR=run_test_awsomchargestate)
	-@($(MAKE) test_awsom_bvector TESTDIR=run_test_awsom_bvector)
	-@($(MAKE) test_bvector TESTDIR=run_test_bvector)
	-@($(MAKE) test_fluxemergence TESTDIR=run_test_fluxemergence)
	-@($(MAKE) test_graydiffusion TESTDIR=run_test_graydiffusion)
	-@($(MAKE) test_eosgodunov TESTDIR=run_test_eosgodunov)
	./Config.pl -nohdf5
	-@($(MAKE) test_laserpackage TESTDIR=run_test_laserpackage)
	./Config.pl -nohypre
	-@($(MAKE) test_ganymede TESTDIR=run_test_ganymede)
	-@($(MAKE) test_europa2fluidspe TESTDIR=run_test_europa2fluidspe)
	-@($(MAKE) test_europa3fluidspe TESTDIR=run_test_europa3fluidspe)

# Default run directory for tests
TESTDIR = run_test

OPENMP = -openmp
OPENACC = -acc

test_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${TESTDIR} STANDALONE=YES GMDIR=`pwd`

### FLUX EMERGENCE TEST ###

test_fluxemergence:
	@echo "test_fluxemergence_compile..." > test_fluxemergence.diff
	$(MAKE) test_fluxemergence_compile
	@echo "test_fluxemergence_rundir..." >> test_fluxemergence.diff
	$(MAKE) test_fluxemergence_rundir 
	@echo "test_fluxemergence_run..." >> test_fluxemergence.diff
	$(MAKE) test_fluxemergence_run
	@echo "test_fluxemergence_check..." >> test_fluxemergence.diff
	$(MAKE) test_fluxemergence_check

test_fluxemergence_compile:
	./Config.pl -default -e=MhdEosRad -u=Ee -ng=2 -g=10,10,10
	$(MAKE) BATSRUS
	make PIDL

test_fluxemergence_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${TESTDIR} COMPONENT=EE STANDALONE=YES GMDIR=`pwd`
	cd ${TESTDIR}; cp ../data/FLUXEMERGENCE/*.dat* .
	cd ${TESTDIR}; cp Param/FLUXEMERGENCE/Grid.* .
	cd ${TESTDIR}; gunzip *.gz
	cd ${TESTDIR}; cp Param/CORONA/RadCoolCorona.dat .
	cd ${TESTDIR}; cp Param/FLUXEMERGENCE/PARAM.in.FluxEmergence.1D PARAM.in

test_fluxemergence_run:
	cd ${TESTDIR}; cp Param/FLUXEMERGENCE/PARAM.in.FluxEmergence.1D PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog_1d
	cd ${TESTDIR}; ./PostProc.pl -M -cat -replace RESULTS/run_1d
	cd ${TESTDIR}; cp Param/FLUXEMERGENCE/PARAM.in.FluxEmergence.3D PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog_3d
	cd ${TESTDIR}; ./Restart.pl
	cd ${TESTDIR}; ./PostProc.pl -M -cat -replace RESULTS/run_3d
	cd ${TESTDIR}; cp Param/FLUXEMERGENCE/PARAM.in.FluxEmergence PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog_restart
	cd ${TESTDIR}; ./PostProc.pl -M -cat -replace RESULTS/run_restart; \
				mv runlog_restart RESULTS/run_restart

test_fluxemergence_check:
	-@(${DIFFNUM} -t \
		${TESTDIR}/RESULTS/run_restart/EE/log_n000011.log \
		Param/FLUXEMERGENCE/TestOutput/log_fluxemergence.log \
		> test_fluxemergence.diff)
	ls -l test_fluxemergence.diff

### SHOCK TUBE TEST ###

test_shocktube:
	@echo "test_shocktube_compile..." > test_shocktube.diff
	$(MAKE) test_shocktube_compile
	@echo "test_shocktube_rundir..." >> test_shocktube.diff
	$(MAKE) test_shocktube_rundir
	@echo "test_shocktube_run..." >> test_shocktube.diff
	$(MAKE) test_shocktube_run
	@echo "test_shocktube_check..." >> test_shocktube.diff
	$(MAKE) test_shocktube_check

test_shocktube_compile:
	./Config.pl -default -u=Default -e=MhdHyp -ng=2 -g=64,4,1
	$(MAKE) BATSRUS
	make PIDL

test_shocktube_rundir: test_rundir
	cd ${TESTDIR}; cp Param/SHOCKTUBE/PARAM.in.hyp PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_shocktube_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m -replace RESULT

test_shocktube_check:
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-11 \
		${TESTDIR}/RESULT/GM/1d_*t25.6*.out \
		Param/SHOCKTUBE/TestOutput/mhdhyp_ref.out \
		> test_shocktube.diff)
	ls -l test_shocktube.diff

### TIMEWARP SHOCK TUBE TEST ###

test_timewarp_1d:
	@echo "test_timewarp_1d_compile..." > test_timewarp_1d.diff
	$(MAKE) test_timewarp_1d_compile
	@echo "test_timewarp_1d_rundir..." >> test_timewarp_1d.diff
	$(MAKE) test_timewarp_1d_rundir
	@echo "test_timewarp_1d_run..." >> test_timewarp_1d.diff
	$(MAKE) test_timewarp_1d_run
	@echo "test_timewarp_1d_check..." >> test_timewarp_1d.diff
	$(MAKE) test_timewarp_1d_check

test_timewarp_1d_compile:
	./Config.pl -default -u=Default -e=Mhd -ng=2 -g=64,1,1
	$(MAKE) BATSRUS
	make PIDL

test_timewarp_1d_rundir: test_rundir
	cd ${TESTDIR}; cp Param/SHOCKTUBE/PARAM.in.timewarp1d PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_timewarp_1d_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m -replace RESULT

test_timewarp_1d_check:
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-7 \
		${TESTDIR}/RESULT/GM/1d_*008_*.out \
		Param/SHOCKTUBE/TestOutput/timewarp1d.out \
		> test_timewarp_1d.diff)
	ls -l test_timewarp_1d.diff

### TIMEWARP 2D TEST ###

test_timewarp_2d:
	@echo "test_timewarp_2d_compile..." > test_timewarp_2d.diff
	$(MAKE) test_timewarp_2d_compile
	@echo "test_timewarp_2d_rundir..." >> test_timewarp_2d.diff
	$(MAKE) test_timewarp_2d_rundir
	@echo "test_timewarp_2d_run..." >> test_timewarp_2d.diff
	$(MAKE) test_timewarp_2d_run
	@echo "test_timewarp_2d_check..." >> test_timewarp_2d.diff
	$(MAKE) test_timewarp_2d_check

test_timewarp_2d_compile:
	./Config.pl -default -u=Default -e=Mhd -ng=2 -g=64,64,1
	$(MAKE) BATSRUS
	make PIDL

test_timewarp_2d_rundir: test_rundir
	cd ${TESTDIR}; cp Param/SHOCKTUBE/PARAM.in.timewarp2d PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_timewarp_2d_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m -replace RESULT

test_timewarp_2d_check:
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-7 \
		${TESTDIR}/RESULT/GM/z=0_*006_*.out \
		Param/SHOCKTUBE/TestOutput/timewarp2d.out.gz \
		> test_timewarp_2d.diff)
	ls -l test_timewarp_2d.diff

### ROUND CUBE SHOCK TUBE TEST ###

test_shockround:
	@echo "test_shockround_compile..." > test_shockround.diff
	$(MAKE) test_shockround_compile
	@echo "test_shockround_rundir..." >> test_shockround.diff
	$(MAKE) test_shockround_rundir
	@echo "test_shockround_run..." >> test_shockround.diff
	$(MAKE) test_shockround_run
	@echo "test_shockround_check..." >> test_shockround.diff
	$(MAKE) test_shockround_check

test_shockround_compile:
	./Config.pl -default ${OPENMP} -u=Default -e=Mhd -ng=2 -g=4,4,4
	$(MAKE) BATSRUS
	make PIDL

test_shockround_rundir: test_rundir
	cd ${TESTDIR}; cp Param/SHOCKTUBE/PARAM.in.roundcube PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_shockround_run:
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m -replace RESULT

test_shockround_check:
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-11 \
		${TESTDIR}/RESULT/GM/log*.log \
		Param/SHOCKTUBE/TestOutput/shockround.log \
		> test_shockround.diff)
	ls -l test_shockround.diff


### 1D SHOCK TUBE TEST ###

test_shocktube_1d:
	@echo "test_shocktube_1d_compile..." > test_shocktube_1d_gpu.diff
	$(MAKE) test_shocktube_1d_compile
	@echo "test_shocktube_1d_rundir..." >> test_shocktube_1d_gpu.diff
	$(MAKE) test_shocktube_1d_rundir
	@echo "test_shocktube_1d_run..." >> test_shocktube_1d_gpu.diff
	$(MAKE) test_shocktube_1d_run
	@echo "test_shocktube_1d_check..." >> test_shocktube_1d_gpu.diff
	$(MAKE) test_shocktube_1d_check

test_shocktube_1d_compile:
	./Config.pl -default ${OPENACC}
	./Config.pl -u=Default -e=MhdHyp -ng=2 -g=64,1,1
	./Config.pl -opt=Param/SHOCKTUBE/PARAM.in.hyp.1d
	$(MAKE) BATSRUS
	make PIDL

test_shocktube_1d_rundir: test_rundir
	cd ${TESTDIR}; cp Param/SHOCKTUBE/PARAM.in.hyp.1d PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_shocktube_1d_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m -replace RESULT

test_shocktube_1d_check:
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-11 \
		${TESTDIR}/RESULT/GM/1d_*t25.6*.out \
		Param/SHOCKTUBE/TestOutput/mhdhyp_1d_ref.out \
		> test_shocktube_1d_gpu.diff)
	ls -l test_shocktube_1d_gpu.diff


### FASTWAVE TEST SIMPLIFIED ###

test_fastwave_2d:
	@echo "test_fastwave_2d_compile..." > test_fastwave_2d_gpu.diff
	$(MAKE) test_fastwave_2d_compile
	@echo "test_fastwave_2d_rundir..." >> test_fastwave_2d_gpu.diff
	$(MAKE) test_fastwave_2d_rundir
	@echo "test_fastwave_2d_run..." >> test_fastwave_2d_gpu.diff
	$(MAKE) test_fastwave_2d_run
	@echo "test_fastwave_2d_check..." >> test_fastwave_2d_gpu.diff
	$(MAKE) test_fastwave_2d_check

test_fastwave_2d_compile:
	./Config.pl -default ${OPENACC}
	./Config.pl -u=Default -e=Mhd -ng=2 -g=6,6,1
	./Config.pl -opt=Param/SHOCKTUBE/PARAM.in.fast_wave_2d
	$(MAKE) BATSRUS
	make PIDL

test_fastwave_2d_rundir:test_rundir
	cd ${TESTDIR}; cp Param/SHOCKTUBE/PARAM.in.fast_wave_2d PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_fastwave_2d_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m -replace RESULT

test_fastwave_2d_check:
	-@(${DIFFNUM} -t -r=1e-3 -a=1e-6 \
                ${TESTDIR}/RESULT/GM/z=0_mhd_1_t00000500_n00000060.out \
                Param/SHOCKTUBE/TestOutput/fastwave_2d_ref.out \
                > test_fastwave_2d_gpu.diff)
	ls -l test_fastwave_2d_gpu.diff

### 2D HEAT CONDUCTION TEST ###

test_heatcond_2d:
	@echo "test_heatcond_2d_compile..." > test_heatcond_2d_gpu.diff
	$(MAKE) test_heatcond_2d_compile
	@echo "test_heatcond_2d_rundir..." >> test_heatcond_2d_gpu.diff
	$(MAKE) test_heatcond_2d_rundir
	@echo "test_heatcond_2d_run..." >> test_heatcond_2d_gpu.diff
	$(MAKE) test_heatcond_2d_run
	@echo "test_heatcond_2d_check..." >> test_heatcond_2d_gpu.diff
	$(MAKE) test_heatcond_2d_check

test_heatcond_2d_compile:
	./Config.pl -default ${OPENACC}
	./Config.pl -u=Default -e=MhdPe -ng=2 -f -g=4,4,1
	./Config.pl -opt=Param/CORONA/PARAM.in.heat.cond
	$(MAKE) BATSRUS
	make PIDL

test_heatcond_2d_rundir:test_rundir
	cd ${TESTDIR}; cp Param/CORONA/PARAM.in.heat.cond PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_heatcond_2d_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m -replace RESULT

test_heatcond_2d_check:
	-@(${DIFFNUM} -t -r=1e-9 -a=1e-9 \
                ${TESTDIR}/RESULT/GM/z=0_mhd_1_t00000000_n00000002.out \
                Param/CORONA/TestOutput/heatcond_2d_ref.out \
                > test_heatcond_2d_gpu.diff)
	ls -l test_heatcond_2d_gpu.diff


### SHOCKRAMP TEST ###

test_shockramp:
	@echo "test_shockramp_compile..." > test_shockramp.diff
	$(MAKE) test_shockramp_compile
	@echo "test_shockramp_rundir..." >> test_shockramp.diff
	$(MAKE) test_shockramp_rundir
	@echo "test_shockramp_run..." >> test_shockramp.diff
	$(MAKE) test_shockramp_run
	@echo "test_shockramp_check..." >> test_shockramp.diff
	$(MAKE) test_shockramp_check

test_shockramp_compile:
	./Config.pl -default ${OPENMP} -u=Waves -e=Hd -g=6,6,1 -ng=3
	$(MAKE) BATSRUS
	make PIDL

test_shockramp_rundir: test_rundir
	cd ${TESTDIR}; cp Param/SHOCKTUBE/PARAM.in.shockramp PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_shockramp_run:
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m -replace RESULT

test_shockramp_check:
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-11 \
	   ${TESTDIR}/RESULT/GM/z=0_*t00.05*.out \
	   Param/SHOCKTUBE/TestOutput/shockramp.out.gz \
		> test_shockramp.diff)
	ls -l test_shockramp.diff

### 3D FAST WAVE TEST ###

test_fastwave:
	@echo "test_fastwave_compile..." > test_fastwave_gpu.diff
	$(MAKE) test_fastwave_compile
	@echo "test_fastwave_rundir..." >> test_fastwave_gpu.diff
	$(MAKE) test_fastwave_rundir
	@echo "test_fastwave_run..." >> test_fastwave_gpu.diff
	$(MAKE) test_fastwave_run
	@echo "test_fastwave_check..." >> test_fastwave_gpu.diff
	$(MAKE) test_fastwave_check

test_fastwave_compile:
	./Config.pl -default ${OPENACC}
	./Config.pl -u=Default -e=Mhd -ng=2 -g=10,10,10
	./Config.pl -opt=Param/SHOCKTUBE/PARAM.in.fast_wave
	$(MAKE) BATSRUS
	make PIDL

test_fastwave_rundir: test_rundir
	cd ${TESTDIR}; cp Param/SHOCKTUBE/PARAM.in.fast_wave PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_fastwave_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m -replace RESULT

test_fastwave_check:
	-@(${DIFFNUM} -t -r=1e-3 -a=1e-6 \
		${TESTDIR}/RESULT/GM/z*_n00000150.out \
		Param/SHOCKTUBE/TestOutput/fast_wave_ref.out \
		> test_fastwave_gpu.diff)
	ls -l test_fastwave_gpu.diff

### 3D BX0 TEST ###

test_bx0:
	@echo "test_bx0_compile..." > test_bx0.diff
	$(MAKE) test_bx0_compile
	@echo "test_bx0_rundir..." >> test_bx0.diff
	$(MAKE) test_bx0_rundir
	@echo "test_bx0_run..." >> test_bx0.diff
	$(MAKE) test_bx0_run
	@echo "test_bx0_check..." >> test_bx0.diff
	$(MAKE) test_bx0_check

test_bx0_compile:
	./Config.pl -default -u=Default -e=Mhd -g=10,10,10
	$(MAKE) BATSRUS
	make PIDL

test_bx0_rundir: test_rundir
	cd ${TESTDIR}; cp Param/SHOCKTUBE/PARAM.in.bx0 PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_bx0_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m -replace RESULT

test_bx0_check:
	-@(${DIFFNUM} -t -r=1e-3 -a=1e-6 \
		${TESTDIR}/RESULT/GM/bx0*_n00000001.out \
		Param/SHOCKTUBE/TestOutput/bx0_ref.out \
		> test_bx0.diff)
	ls -l test_bx0.diff

### PART STEADY TEST ###

test_partsteady:
	@echo "test_partsteady_compile..." > test_partsteady.diff
	$(MAKE) test_partsteady_compile
	@echo "test_partsteady_rundir..." >> test_partsteady.diff
	$(MAKE) test_partsteady_rundir
	@echo "test_partsteady_run..." >> test_partsteady.diff
	$(MAKE) test_partsteady_run
	@echo "test_partsteady_check..." >> test_partsteady.diff
	$(MAKE) test_partsteady_check

test_partsteady_compile:
	./Config.pl -default -u=Default -e=MhdHyp -ng=2 -g=4,4,1
	$(MAKE) BATSRUS
	make PIDL

test_partsteady_rundir: test_rundir
	cd ${TESTDIR}; cp Param/SHOCKTUBE/PARAM.in.partsteady PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_partsteady_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m -replace RESULT

test_partsteady_check:
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-11 \
		${TESTDIR}/RESULT/GM/cut_*t25.6*.out \
		Param/SHOCKTUBE/TestOutput/partsteady_ref.out \
		> test_partsteady.diff)
	ls -l test_partsteady.diff


### HALL MHD TEST ###

test_hallmhd:
	@echo "test_hallmhd_compile..." > test_hallmhd.diff
	$(MAKE) test_hallmhd_compile
	@echo "test_hallmhd_rundir..." >> test_hallmhd.diff
	$(MAKE) test_hallmhd_rundir
	@echo "test_hallmhd_run..." >> test_hallmhd.diff
	$(MAKE) test_hallmhd_run
	@echo "test_hallmhd_check..." >> test_hallmhd.diff
	$(MAKE) test_hallmhd_check

test_hallmhd_compile:
	./Config.pl -default -u=Default -e=Mhd -f -ng=2 -g=4,2,2
	$(MAKE) BATSRUS
	make PIDL

test_hallmhd_rundir: test_rundir
	cd ${TESTDIR}; cp Param/SHOCKTUBE/PARAM.in.HallTest PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_hallmhd_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m -replace RESULT

test_hallmhd_check:
	-@(${DIFFNUM} -t -r=1e-5 -a=2e-7 \
	  ${TESTDIR}/RESULT/GM/1d_*20.out \
	  Param/SHOCKTUBE/TestOutput/hall_ref.out \
	  > test_hallmhd.diff)
	ls -l test_hallmhd.diff

### HYBRID TEST ###

test_hybrid:
	@echo "test_hybrid_compile..." > test_hybrid.diff
	$(MAKE) test_hybrid_compile
	@echo "test_hybrid_rundir..." >> test_hybrid.diff
	$(MAKE) test_hybrid_rundir
	@echo "test_hybrid_run..." >> test_hybrid.diff
	$(MAKE) test_hybrid_run
	@echo "test_hybrid_check..." >> test_hybrid.diff
	$(MAKE) test_hybrid_check

test_hybrid_compile:
	./Config.pl -default ${OPENMP} -u=Hybrid -e=Mhd -f -ng=2 -g=4,2,2
	$(MAKE) BATSRUS
	make PIDL

test_hybrid_rundir: test_rundir
	cd ${TESTDIR}; cp Param/SHOCKTUBE/PARAM.in.HybridTest PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_hybrid_run:
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m -replace RESULT

test_hybrid_check:
	-@(${DIFFNUM} -t -r=1e-5 -a=2e-7 \
          ${TESTDIR}/RESULT/GM/1d_*20.out \
          Param/SHOCKTUBE/TestOutput/hall_ref.out \
	  > test_hybrid.diff)
	ls -l test_hybrid.diff


### VISCOSITY TEST ###

test_viscosity:
	@echo "test_viscosity_compile..." > test_viscosity.diff
	$(MAKE) test_viscosity_compile
	@echo "test_viscosity_rundir..." >> test_viscosity.diff
	$(MAKE) test_viscosity_rundir 
	@echo "test_viscosity_run..." >> test_viscosity.diff
	$(MAKE) test_viscosity_run
	@echo "test_viscosity_check..." >> test_viscosity.diff
	$(MAKE) test_viscosity_check

test_viscosity_compile:
	./Config.pl -default ${OPENMP} -e=Hd -u=Waves -ng=2 -g=16,4,1
	$(MAKE) BATSRUS
	make PIDL

test_viscosity_rundir: test_rundir
	cd ${TESTDIR}; cp Param/VISCOSITY/PARAM.in PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_viscosity_run:
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS

test_viscosity_check:
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-11 \
		${TESTDIR}/RESULTS/GM/z=0*.outs \
		Param/VISCOSITY/TestOutput/z=0_ref.outs \
		> test_viscosity.diff)
	ls -l test_viscosity.diff

### TWOFLUID MHD TEST ###

test_twofluidmhd:
	@echo "test_twofluidmhd_compile..." > test_twofluidmhd.diff
	$(MAKE) test_twofluidmhd_compile
	@echo "test_twofluidmhd_rundir..." >> test_twofluidmhd.diff
	$(MAKE) test_twofluidmhd_rundir
	@echo "test_twofluidmhd_run..." >> test_twofluidmhd.diff
	$(MAKE) test_twofluidmhd_run
	@echo "test_twofluidmhd_check..." >> test_twofluidmhd.diff
	$(MAKE) test_twofluidmhd_check

test_twofluidmhd_compile:
	./Config.pl -default ${OPENMP} -u=Default -e=MhdHypPe -f -ng=2 -g=64,2,2
	$(MAKE) BATSRUS
	make PIDL

test_twofluidmhd_rundir: test_rundir
	cd ${TESTDIR}; cp Param/SHOCKTUBE/PARAM.in.TwofluidTest PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_twofluidmhd_run:
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m -replace RESULT

test_twofluidmhd_check:
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-13 \
		${TESTDIR}/RESULT/GM/cut_mhd_1_t00000020*.out \
		Param/SHOCKTUBE/TestOutput/twofluid_ref.out \
	  > test_twofluidmhd.diff)
	ls -l test_twofluidmhd.diff


### MULTI FLUID TEST ###

test_multifluid:
	@echo "test_multifluid_compile..." > test_multifluid.diff
	$(MAKE) test_multifluid_compile
	@echo "test_multifluid_rundir..." >> test_multifluid.diff
	$(MAKE) test_multifluid_rundir
	@echo "test_multifluid_run..." >> test_multifluid.diff
	$(MAKE) test_multifluid_run
	@echo "test_multifluid_check..." >> test_multifluid.diff
	$(MAKE) test_multifluid_check

test_multifluid_compile:
	./Config.pl -default ${OPENMP} -u=Default -e=MhdHd -f -ng=2 -g=64,2,2
	$(MAKE) BATSRUS
	make PIDL

test_multifluid_rundir: test_rundir
	cd ${TESTDIR}; cp Param/MULTIFLUID/PARAM.in .
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_multifluid_run:
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m -replace RESULT

test_multifluid_check:
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-12 \
		${TESTDIR}/RESULT/GM/cut_*025_n*.out \
		Param/MULTIFLUID/TestOutput/cut_t25.out \
		> test_multifluid.diff)
	ls -l test_multifluid.diff

### MAGNETOMETER TEST ###

test_magnetometer:
	@echo "test_magnetometer_compile..." >> test_magnetometer.diff
	$(MAKE) test_magnetometer_compile
	@echo "test_magnetometer_rundir..." >> test_magnetometer.diff
	$(MAKE) test_magnetometer_rundir
	@echo "test_magnetometer_run..." >> test_magnetometer.diff
	$(MAKE) test_magnetometer_run
	@echo "test_magnetometer_check..." >> test_magnetometer.diff
	$(MAKE) test_magnetometer_check

test_magnetometer_compile:
	./Config.pl -default ${OPENMP} -u=Default -e=Mhd -ng=2 -g=4,4,4
	$(MAKE) BATSRUS
	make PIDL
	
test_magnetometer_rundir: test_rundir
	cd ${TESTDIR}; cp Param/MAGNETOMETER/magin.dat .
	cd ${TESTDIR}; cp Param/MAGNETOMETER/PARAM.in PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in
	
test_magnetometer_run:
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl

test_magnetometer_check:
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-12 \
		${TESTDIR}/IO2/magnetometers_n00000000.mag \
		Param/MAGNETOMETER/TestOutput/magnetometers_n00000000.mag \
		> test_magnetometer.diff)
	-@(${DIFFNUM} -t -r=1e-5 -a=3e-9 \
		${TESTDIR}/IO2/eqb_t00000100_n*.out \
		Param/MAGNETOMETER/TestOutput/eqb_t00000100.out \
		>> test_magnetometer.diff)
	-@(${DIFFNUM} -t -r=1e-5 -a=3e-9 \
		${TESTDIR}/IO2/eqb_t00000100_n*.dat \
		Param/MAGNETOMETER/TestOutput/eqb_t00000100.dat \
		>> test_magnetometer.diff)
	-@(${DIFFNUM} -t -r=1e-5 -a=3e-9 \
		${TESTDIR}/IO2/bx0_mhd_6_t00000100*.out \
		Param/MAGNETOMETER/TestOutput/bx0_t00000100.out \
		>> test_magnetometer.diff)
	ls -l test_magnetometer.diff

### MULTI ION TEST ###

test_multiion:
	@echo "test_multiion_compile..." > test_multiion.diff
	$(MAKE) test_multiion_compile
	@echo "test_multiion_rundir..." >> test_multiion.diff
	$(MAKE) test_multiion_rundir
	@echo "test_multiion_run..." >> test_multiion.diff
	$(MAKE) test_multiion_run
	@echo "test_multiion_check..." >> test_multiion.diff
	$(MAKE) test_multiion_check

test_multiion_compile:
	./Config.pl -default -u=Default -e=MultiIonPe -ng=2 -g=64,1,1
	$(MAKE) BATSRUS
	make PIDL

test_multiion_rundir: test_rundir
	cd ${TESTDIR}; cp Param/MULTIION/PARAM.in .
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_multiion_run:
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m -replace RESULTS

test_multiion_check:
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-12 \
		${TESTDIR}/RESULTS/GM/1d_*t00.2*.out \
		Param/MULTIION/TestOutput/1d_t2.out \
		> test_multiion.diff)
	ls -l test_multiion.diff

### NONCONSERVATIVE MHD TEST ###

test_mhdnoncons:
	@echo "test_mhdnoncons_compile..." > test_mhdnoncons.diff
	$(MAKE) test_mhdnoncons_compile
	@echo "test_mhdnoncons_rundir..." >> test_mhdnoncons.diff
	$(MAKE) test_mhdnoncons_rundir
	@echo "test_mhdnoncons_run..." >> test_mhdnoncons.diff
	$(MAKE) test_mhdnoncons_run
	@echo "test_mhdnoncons_check..." >> test_mhdnoncons.diff
	$(MAKE) test_mhdnoncons_check

test_mhdnoncons_compile:
	./Config.pl -default ${OPENMP} -u=Default -e=MhdNonCons -f -ng=2 -g=64,2,2
	$(MAKE) BATSRUS
	make PIDL

test_mhdnoncons_rundir: test_rundir
	cd ${TESTDIR}; cp Param/MHDNONCONS/PARAM.in .
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_mhdnoncons_run:
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m -replace RESULTS

test_mhdnoncons_check:
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-11 \
		${TESTDIR}/RESULTS/GM/cut_mhd_1_t00001000*.out \
		Param/MHDNONCONS/TestOutput/cut_mhd_t10m.out \
		> test_mhdnoncons.diff)
	ls -l test_mhdnoncons.diff

### CRASH RELATED TESTS ###############################################

### EQUATION OF STATE AND GODUNOV SOLVER TEST ###

test_eosgodunov:
	@echo "test_eosgodunov_compile..." > test_eosgodunov.diff
	$(MAKE) test_eosgodunov_compile
	@echo "test_eosgodunov_rundir..." >> test_eosgodunov.diff
	$(MAKE) test_eosgodunov_rundir
	@echo "test_eosgodunov_run..." >> test_eosgodunov.diff
	$(MAKE) test_eosgodunov_run
	@echo "test_eosgodunov_check..." >> test_eosgodunov.diff
	$(MAKE) test_eosgodunov_check

test_eosgodunov_compile:
	./Config.pl -default -e=HdEos -u=Eos -ng=2 -g=10,1,1
	$(MAKE) CRASH
	make PIDL

test_eosgodunov_rundir: test_rundir
	cd ${TESTDIR}; cp Param/CRASH/PARAM.in.eosgodunov PARAM.in; \
	   	       ln -s ${BINDIR}/CRASH.exe . 
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_eosgodunov_run:
	cd ${TESTDIR}; ${MPIRUN} ./CRASH.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m -replace RESULT

test_eosgodunov_check:
	-@(${DIFFNUM} -t -r=1e-5 -a=3e-7 \
		${TESTDIR}/RESULT/GM/cut_*500.0*.out \
		Param/CRASH/TestOutput/eosgodunov.out \
		> test_eosgodunov.diff)
	ls -l test_eosgodunov.diff

### LASER PACKAGE TEST ###

test_laserpackage:
	@echo "test_laserpackage_compile..." > test_laserpackage.diff
	$(MAKE) test_laserpackage_compile
	@echo "test_laserpackage_rundir..." >> test_laserpackage.diff
	$(MAKE) test_laserpackage_rundir DEFAULT_EXE=CRASH.exe
	@echo "test_laserpackage_run..." >> test_laserpackage.diff
	$(MAKE) test_laserpackage_run
	@echo "test_laserpackage_check..." >> test_laserpackage.diff
	$(MAKE) test_laserpackage_check

test_laserpackage_compile:
	./Config.pl -e=Crash -u=Crash -ng=2 -g=8,8,1 -nMaterial=5 -nWave=30
	./Config.pl -default -hypre
	$(MAKE) CRASH
	make PIDL

test_laserpackage_rundir: test_rundir
	cd ${TESTDIR}; cp Param/CRASH/PARAM.in.laserpackage PARAM.in
	cd ${TESTDIR}; ln -s ../dataCRASH/LookupTables Tables
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_laserpackage_run:
	cd ${TESTDIR}; ${MPIRUN} ./CRASH.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS

test_laserpackage_check:
	-@(${DIFFNUM} -t -r=2e-5 \
		${TESTDIR}/RESULTS/GM/log_n000000.log \
		Param/CRASH/TestOutput/log_laserpackage.log \
		> test_laserpackage.diff)
	ls -l test_laserpackage.diff


### GRAY-DIFFUSION TEST ###

test_graydiffusion:
	@echo "test_graydiffusion_compile..." > test_graydiffusion.diff
	$(MAKE) test_graydiffusion_compile
	@echo "test_graydiffusion_rundir..." >> test_graydiffusion.diff
	$(MAKE) test_graydiffusion_rundir
	@echo "test_graydiffusion_run..." >> test_graydiffusion.diff
	$(MAKE) test_graydiffusion_run
	@echo "test_graydiffusion_check..." >> test_graydiffusion.diff
	$(MAKE) test_graydiffusion_check

test_graydiffusion_compile:
	./Config.pl -e=HdEosRad -u=GrayDiffusion -ng=2 -g=32,4,4
	./Config.pl -default 
	$(MAKE) BATSRUS
	make PIDL

test_graydiffusion_rundir: test_rundir
	cd ${TESTDIR}; cp Param/CRASH/PARAM.in.graydiffusion PARAM.in
	cd ${TESTDIR}; gunzip -c Param/CRASH/initial_lowrie3.dat.gz > initial_lowrie3.dat
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_graydiffusion_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS

test_graydiffusion_check:
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-4 \
		${TESTDIR}/RESULTS/GM/log_n000000.log \
		Param/CRASH/TestOutput/log_graydiffusion.log \
		> test_graydiffusion.diff)
	ls -l test_graydiffusion.diff

### END OF CRASH RELATED TESTS #############################################

### STANDALONE SOLAR CORONA TESTS ###

### AWSOM test on GPU

test_awsom_gpu:
	@echo "test_awsom_gpu_compile..." > test_awsom_gpu.diff
	$(MAKE) test_awsom_gpu_compile
	@echo "test_awsom_gpu_rundir..." >> test_awsom_gpu.diff
	$(MAKE) test_awsom_gpu_rundir
	@echo "test_awsom_gpu_run..." >> test_awsom_gpu.diff
	$(MAKE) test_awsom_gpu_run
	@echo "test_awsom_gpu_check..." >> test_awsom_gpu.diff
	$(MAKE) test_awsom_gpu_check

# Fails on Pleiades with OpenMP
test_awsom_gpu_compile:
	./Config.pl -default ${OPENACC}
	./Config.pl -u=Awsom -e=Awsom -ng=2 -g=6,4,4
	./Config.pl -opt=Param/CORONA/PARAM.in.Awsom.GPU
	$(MAKE) BATSRUS
	make PIDL

test_awsom_gpu_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${TESTDIR} COMPONENT=SC STANDALONE=YES GMDIR=`pwd`
	cd ${TESTDIR}; cp Param/CORONA/PARAM.in.Awsom.GPU PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_awsom_gpu_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS
	
test_awsom_gpu_check:
	-@(${DIFFNUM} -a=5e-19 -r=2e-4 -t \
		${TESTDIR}/RESULTS/SC/log_n000001.log \
		Param/CORONA/TestOutput/log_n000001.awsom_gpu \
		> test_awsom_gpu.diff)
	ls -l test_awsom_gpu.diff

### AWSOM test on GPU with typical grid size

test_awsom_large_gpu:
	@echo "test_awsom_large_gpu_compile..." > test_awsom_large_gpu.diff
	$(MAKE) test_awsom_large_gpu_compile
	@echo "test_awsom_large_gpu_rundir..." >> test_awsom_large_gpu.diff
	$(MAKE) test_awsom_large_gpu_rundir
	@echo "test_awsom_large_gpu_run..." >> test_awsom_large_gpu.diff
	$(MAKE) test_awsom_large_gpu_run
	@echo "test_awsom_large_gpu_check..." >> test_awsom_large_gpu.diff
	$(MAKE) test_awsom_large_gpu_check

# Fails on Pleiades with OpenMP
test_awsom_large_gpu_compile:
	./Config.pl -default ${OPENACC}
	./Config.pl -u=Awsom -e=Awsom -ng=2 -g=12,8,8
	./Config.pl -opt=Param/CORONA/PARAM.in.Awsom.large.GPU
	$(MAKE) BATSRUS
	make PIDL

test_awsom_large_gpu_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${TESTDIR} COMPONENT=SC STANDALONE=YES GMDIR=`pwd`
	cd ${TESTDIR}; cp Param/CORONA/PARAM.in.Awsom.large.GPU PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_awsom_large_gpu_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS
	
test_awsom_large_gpu_check:
	-@(${DIFFNUM} -a=5e-19 -r=1e-5 -t \
		${TESTDIR}/RESULTS/SC/log_n*.log \
		Param/CORONA/TestOutput/log.awsom_large_gpu \
		> test_awsom_large_gpu.diff)
	ls -l test_awsom_large_gpu.diff


### AWSOM TEST  WITH CHARGE STATES

test_awsomchargestate:
	@echo "test_awsomchargestate_compile..." > test_awsomchargestate.diff
	$(MAKE) test_awsomchargestate_compile
	@echo "test_awsomchargestate_rundir..." >> test_awsomchargestate.diff
	$(MAKE) test_awsomchargestate_rundir
	@echo "test_awsomchargestate_run..." >> test_awsomchargestate.diff
	$(MAKE) test_awsomchargestate_run
	@echo "test_awsomchargestate_check..." >> test_awsomchargestate.diff
	$(MAKE) test_awsomchargestate_check

# Test fails on Pleiades with OpenMP

test_awsomchargestate_compile:
	./Config.pl -e=AwsomChargeState -u=AwsomIons -ng=2 -g=6,8,8 -cs=o
	./Config.pl -default 
	$(MAKE) BATSRUS
	make PIDL

test_awsomchargestate_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${TESTDIR} COMPONENT=SC STANDALONE=YES GMDIR=`pwd`
	cd ${TESTDIR}; cp Param/CORONA/PARAM.in.AwsomChargeState PARAM.in
	cd ${TESTDIR}; cp ../data/CHARGESTATE/o_tbl.dat.gz .
	cd ${TESTDIR}; cp ../data/SPECTRUM/PHOTOEXC_6376.2900.dat.gz .	
	cd ${TESTDIR}; cp ../data/SPECTRUM/SPECTRUM_chianti_tbl.dat.gz .
	cd ${TESTDIR}; cp ../data/SPECTRUM/eit195response.out.gz .	
	cd ${TESTDIR}; gunzip o_tbl.dat.gz
	cd ${TESTDIR}; gunzip PHOTOEXC_6376.2900.dat.gz
	cd ${TESTDIR}; gunzip SPECTRUM_chianti_tbl.dat.gz
	cd ${TESTDIR}; gunzip eit195response.out.gz
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_awsomchargestate_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -g -M -replace RESULTS

test_awsomchargestate_check:
	-@(${DIFFNUM} -a=1e-6 -r=1e-7 -t \
		${TESTDIR}/RESULTS/SC/log_n000001.log \
		Param/CORONA/TestOutput/log_awsomchargestate.log \
		> test_awsomchargestate.diff)
	-@(${DIFFNUM} -a=1e-6 -r=1e-7	 -t \
                ${TESTDIR}/RESULTS/SC/pcl_01__n000001.pcl \
                Param/CORONA/TestOutput/pcl_01__n000001.pcl.gz \
                >> test_awsomchargestate.diff)
	-@(${DIFFNUM} -a=1e-6 -r=1e-7 -t \
		${TESTDIR}/RESULTS/SC/los_dem_1_n00000004.out \
		Param/CORONA/TestOutput/los_dem_1_n0000004.out.gz \
		>> test_awsomchargestate.diff)
	-@(${DIFFNUM} -a=1e-6 -r=1e-7 -t \
                ${TESTDIR}/RESULTS/SC/los_fux_2_n00000004.out \
                Param/CORONA/TestOutput/los_fux_2_n0000004.out.gz \
                >> test_awsomchargestate.diff)
	-@(${DIFFNUM} -a=1e-6 -r=1e-7 -t \
                ${TESTDIR}/RESULTS/SC/los_nbi_3_n00000004.out \
                Param/CORONA/TestOutput/los_nbi_3_n0000004.out.gz \
                >> test_awsomchargestate.diff)
	-@(${DIFFNUM} -a=1e-6 -r=1e-7 -t \
                ${TESTDIR}/RESULTS/SC/los_phx_4_n00000004.out \
                Param/CORONA/TestOutput/los_phx_4_n0000004.out.gz \
                >> test_awsomchargestate.diff)
	-@(${DIFFNUM} -a=1e-6 -r=1e-7 -t -p="sort -k1 -k2 -k3 -g | grep -v AUXDATA" \
                ${TESTDIR}/RESULTS/SC/3d__fux_5_n00000004.dat.gz \
                Param/CORONA/TestOutput/3d__fux_5_n00000004.dat.gz \
                >> test_awsomchargestate.diff)
	-@(${DIFFNUM} -a=1e-6 -r=1e-7 -t -p="sort -k1 -k2 -k3 -g | grep -v AUXDATA" \
                ${TESTDIR}/RESULTS/SC/y=0_nbi_6_n00000004.out \
                Param/CORONA/TestOutput/y=0_nbi_6_n00000004.out.gz \
                >> test_awsomchargestate.diff)
	-@(${DIFFNUM} -a=1e-6 -r=1e-7 -t -p="sort -k1 -k2 -k3 -g | grep -v AUXDATA" \
                ${TESTDIR}/RESULTS/SC/3d__phx_7_n00000004.dat.gz \
                Param/CORONA/TestOutput/3d__phx_7_n00000004.dat.gz \
                >> test_awsomchargestate.diff)
	ls -l test_awsomchargestate.diff

### MAGNETOFRICTION CODE USING VECTOR MAGNETOGRAM ###

test_bvector:
	@echo "test_bvector_compile..." > test_bvector.diff
	$(MAKE) test_bvector_compile
	@echo "test_bvector_rundir..." >> test_bvector.diff
	$(MAKE) test_bvector_rundir
	@echo "test_bvector_run..." >> test_bvector.diff
	$(MAKE) test_bvector_run
	@echo "test_bvector_check..." >> test_bvector.diff
	$(MAKE) test_bvector_check

# Fails on Pleiades with OpenMP
test_bvector_compile:
	./Config.pl -default -u=Bvector -e=Mhd -ng=2 -g=8,8,8
	$(MAKE) BATSRUS
	make PIDL

test_bvector_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${TESTDIR} COMPONENT=SC STANDALONE=YES GMDIR=`pwd`
	cd ${TESTDIR}; cp Param/CORONA/PARAM.in.bvector PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_bvector_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS
	
test_bvector_check:
	-@(${DIFFNUM} -t -a=1e-26 -r=2e-5 \
		${TESTDIR}/RESULTS/SC/log_n000000.log \
		Param/CORONA/TestOutput/log_n000000.bvector \
		> test_bvector.diff)
	ls -l test_bvector.diff

### AWSOM TEST WITH NONPOTENTIAL B0local from VECTOR MAGNETOGRAM ###

test_awsom_bvector:
	@echo "test_awsom_bvector_compile..." > test_awsom_bvector.diff
	$(MAKE) test_awsom_bvector_compile
	@echo "test_awsom_bvector_rundir..." >> test_awsom_bvector.diff
	$(MAKE) test_awsom_bvector_rundir
	@echo "test_awsom_bvector_run..." >> test_awsom_bvector.diff
	$(MAKE) test_awsom_bvector_run
	@echo "test_awsom_bvector_check..." >> test_awsom_bvector.diff
	$(MAKE) test_awsom_bvector_check

# Fails on Pleiades with OpenMP
test_awsom_bvector_compile:
	./Config.pl -default -u=Awsom -e=Awsom -ng=2 -g=8,8,8
	$(MAKE) BATSRUS
	make PIDL

test_awsom_bvector_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${TESTDIR} COMPONENT=SC STANDALONE=YES GMDIR=`pwd`
	cd ${TESTDIR}; cp Param/CORONA/PARAM.in.awsom.bvector PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_awsom_bvector_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS
	
test_awsom_bvector_check:
	-@(${DIFFNUM} -t -a=1e-26 -r=2e-5 \
		${TESTDIR}/RESULTS/SC/log_n000001.log \
		Param/CORONA/TestOutput/log_n000001.awsom.bvector \
		> test_awsom_bvector.diff)
	ls -l test_awsom_bvector.diff


### AWSOM TEST WITH CMEs

test_awsom:
	@echo "test_awsom_compile..." > test_awsom.diff
	$(MAKE) test_awsom_compile
	@echo "test_awsom_rundir..." >> test_awsom.diff
	$(MAKE) test_awsom_rundir
	@echo "test_awsom_run..." >> test_awsom.diff
	$(MAKE) test_awsom_run
	@echo "test_awsom_check..." >> test_awsom.diff
	$(MAKE) test_awsom_check

# Fails on Pleiades with OpenMP
test_awsom_compile:
	./Config.pl -default -u=Awsom -e=Awsom -ng=2 -g=6,4,4
	$(MAKE) BATSRUS
	make PIDL

test_awsom_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${TESTDIR} COMPONENT=SC STANDALONE=YES GMDIR=`pwd`
	cd ${TESTDIR}; cp Param/CORONA/PARAM.in.Awsom PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_awsom_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS
	
test_awsom_check:
	-@(${DIFFNUM} -t -a=2e-27 -r=2e-5 \
		${TESTDIR}/RESULTS/SC/log_n000001.log \
		Param/CORONA/TestOutput/log_n000001.awsom \
		> test_awsom.diff)
	ls -l test_awsom.diff

### AWSOM TEST WITH REVERSE FIELD ALGORITHM

test_awsom_signb:
	@echo "test_awsom_signb_compile..." > test_awsom_signb.diff
	$(MAKE) test_awsom_signb_compile
	@echo "test_awsom_signb_rundir..." >> test_awsom_signb.diff
	$(MAKE) test_awsom_signb_rundir
	@echo "test_awsom_signb_run..." >> test_awsom_signb.diff
	$(MAKE) test_awsom_signb_run
	@echo "test_awsom_signb_check..." >> test_awsom_signb.diff
	$(MAKE) test_awsom_signb_check

# Fails on Pleiades with OpenMP
test_awsom_signb_compile:
	./Config.pl -default -u=Awsom -e=AwsomSA -ng=2 -g=6,4,4
	$(MAKE) BATSRUS
	make PIDL

test_awsom_signb_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${TESTDIR} COMPONENT=SC STANDALONE=YES GMDIR=`pwd`
	cd ${TESTDIR}; cp Param/CORONA/PARAM.in.Awsom.signb PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_awsom_signb_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS
	
test_awsom_signb_check:
	-@(${DIFFNUM} -t -a=2e-27 -r=2e-5 \
		${TESTDIR}/RESULTS/SC/log_n000001.log \
		Param/CORONA/TestOutput/log_n000001.awsom.signb \
		> test_awsom_signb.diff)
	ls -l test_awsom_signb.diff

### AWSOM-R TEST WITH TD CME

test_awsomr:
	@echo "test_awsomr_compile..." > test_awsomr.diff
	$(MAKE) test_awsomr_compile
	@echo "test_awsomr_rundit..." >> test_awsomr.diff
	$(MAKE) test_awsomr_rundir
	@echo "test_awsomr_run..." >> test_awsomr.diff
	$(MAKE) test_awsomr_run
	@echo "test_awsomr_check..." >> test_awsomr.diff
	$(MAKE) test_awsomr_check

test_awsomr_compile:
	./Config.pl -default -u=Awsom -e=Awsom -ng=2 -g=6,4,4
	$(MAKE) BATSRUS
	make PIDL

test_awsomr_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${TESTDIR} COMPONENT=SC STANDALONE=YES GMDIR=`pwd`
	cd ${TESTDIR}; cp Param/CORONA/PARAM.in.AwsomR PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_awsomr_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog

test_awsomr_check:
	-@(${DIFFNUM} -t -a=2e-27 -r=2e-5 \
		${TESTDIR}/SC/IO2/log_n000001.log \
		Param/CORONA/TestOutput/log_n000001.awsomr.td \
		 > test_awsomr.diff)
	ls -l test_awsomr.diff

### AWSOM WITH STITCH TEST

test_stitch:
	@echo "test_stitch_compile..." > test_stitch.diff
	$(MAKE) test_stitch_compile
	@echo "test_stitch_rundir..." >> test_stitch.diff
	$(MAKE) test_stitch_rundir
	@echo "test_stitch_run..." >> test_stitch.diff
	$(MAKE) test_stitch_run
	@echo "test_stitch_check..." >> test_stitch.diff
	$(MAKE) test_stitch_check

# Fails on Pleiades with OpenMP
test_stitch_compile:
	./Config.pl -default -u=Awsom -e=Awsom -ng=2 -g=6,4,4
	$(MAKE) BATSRUS
	make PIDL

test_stitch_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${TESTDIR} COMPONENT=SC STANDALONE=YES GMDIR=`pwd`
	cd ${TESTDIR}; cp Param/CORONA/PARAM.in.STITCH PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_stitch_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS
	
test_stitch_check:
	-@(${DIFFNUM} -t -a=4e-15 \
		${TESTDIR}/RESULTS/SC/log_n000000.log \
		Param/CORONA/TestOutput/log_n000000.stitch \
		> test_stitch.diff)
	ls -l test_stitch.diff


### STANDALONE 2D OUTER HELIOSPHERE TEST ###

test_outerhelio2d:
	@echo "test_outerhelio2d_compile..." > test_outerhelio2d.diff
	$(MAKE) test_outerhelio2d_compile
	@echo "test_outerhelio2d_rundir..." >> test_outerhelio2d.diff
	$(MAKE) test_outerhelio2d_rundir
	@echo "test_outerhelio2d_run..." >> test_outerhelio2d.diff
	$(MAKE) test_outerhelio2d_run
	@echo "test_outerhelio2d_check..." >> test_outerhelio2d.diff
	$(MAKE) test_outerhelio2d_check

test_outerhelio2d_compile:
	./Config.pl -default -u=OuterHelio2d -e=OuterHelio2d
	./Config.pl -f -ng=2 -g=10,10,1
	$(MAKE) BATSRUS
	make PIDL INTERPOLATE

test_outerhelio2d_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${TESTDIR} COMPONENT=OH STANDALONE=YES GMDIR=`pwd`
	cd ${TESTDIR}; cp Param/OUTERHELIO/PARAM.in.2D ./PARAM.in
	cd ${TESTDIR}; cp Param/OUTERHELIO/oh2d_l1_test.dat .
	cd ${TESTDIR}; cp Param/OUTERHELIO/oh2d_stereoa_test.dat .
	cd ${TESTDIR}; cp Param/OUTERHELIO/INTERPOLATE.in .
	cd ${TESTDIR}; cp Param/OUTERHELIO/testsat.dat .
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_outerhelio2d_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m -replace RESULTS
	cd ${TESTDIR}; ${BINDIR}/INTERPOLATE.exe < INTERPOLATE.in

test_outerhelio2d_check:
	-@(${DIFFNUM} -t -r=1e-5 \
		${TESTDIR}/RESULTS/OH/z=0_*_e20170102-*.out \
		Param/OUTERHELIO/TestOutput/z=0_2D.out.gz \
		> test_outerhelio2d.diff)
	-@(${DIFFNUM} -t -r=1e-5 \
		${TESTDIR}/RESULTS/interpolated_output.dat \
		Param/OUTERHELIO/TestOutput/interpolation_ref.dat \
		>> test_outerhelio2d.diff)
	ls -l test_outerhelio2d.diff


### STANDALONE OUTER HELIOSPHERE TESTS ###

test_outerhelio:
	@echo "test_outerhelio_compile..." > test_outerhelio.diff
	$(MAKE) test_outerhelio_compile
	@echo "test_outerhelio_rundir..." >> test_outerhelio.diff
	$(MAKE) test_outerhelio_rundir
	@echo "test_outerhelio_run..." >> test_outerhelio.diff
	$(MAKE) test_outerhelio_run
	@echo "test_outerhelio_check..." >> test_outerhelio.diff
	$(MAKE) test_outerhelio_check

test_outerhelio_compile:
	./Config.pl -default -u=OuterHelio -e=OuterHelio -ng=2 -g=4,4,4
	$(MAKE) BATSRUS
	make PIDL

test_outerhelio_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${TESTDIR} COMPONENT=OH STANDALONE=YES GMDIR=`pwd`
	cd ${TESTDIR}; cp Param/OUTERHELIO/PARAM.in .
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_outerhelio_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog_start
	cd ${TESTDIR}; ./Restart.pl
	cd ${TESTDIR}; mv PARAM.in PARAM.in.start; rm -f PARAM.in_orig_
	cd ${TESTDIR}; cp Param/OUTERHELIO/PARAM.in.restart ./PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -cat -replace RESULTS

test_outerhelio_check:
	-@(${DIFFNUM} -t -r=1e-5 \
		${TESTDIR}/RESULTS/OH/log_n000010.log \
		Param/OUTERHELIO/TestOutput/log_n000010.log \
		> test_outerhelio.diff)
	ls -l test_outerhelio.diff

### 1D OUTER HELIOSPHERE TEST ###

test_outerhelio_1d:
	@echo "test_outerhelio_1d_compile..." > test_outerhelio_1d.diff
	$(MAKE) test_outerhelio_1d_compile
	@echo "test_outerhelio_1d_rundir..." >> test_outerhelio_1d.diff
	$(MAKE) test_outerhelio_1d_rundir
	@echo "test_outerhelio_1d_run..." >> test_outerhelio_1d.diff
	$(MAKE) test_outerhelio_1d_run
	@echo "test_outerhelio_1d_check..." >> test_outerhelio_1d.diff
	$(MAKE) test_outerhelio_1d_check

test_outerhelio_1d_compile:
	./Config.pl -default ${OPENMP} -u=OuterHelio -e=OuterHelio -ng=2 -g=4,4,4
	$(MAKE) BATSRUS
	make PIDL

test_outerhelio_1d_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${TESTDIR} COMPONENT=OH STANDALONE=YES GMDIR=`pwd`
	cd ${TESTDIR}; cp Param/OUTERHELIO/PARAM.in.1d ./PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_outerhelio_1d_run:
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -cat -replace RESULTS

test_outerhelio_1d_check:
	-@(${DIFFNUM} -t -r=1e-5 \
                ${TESTDIR}/RESULTS/OH/log_n000000.log \
                Param/OUTERHELIO/TestOutput/log_n000000_1d.log \
                > test_outerhelio_1d.diff)
	ls -l test_outerhelio_1d.diff

### OUTER HELIOSPHERE TEST WITH PUI AND TURBULENCE ###

test_outerhelioawsom:
	@($(MAKE) test_outerhelioawsom_start)
	@($(MAKE) test_outerhelioawsom_restart)

test_outerhelioawsom_start:
	@echo "test_outerhelioawsom_compile..." > test_outerhelioawsom.diff
	$(MAKE) test_outerhelioawsom_compile
	@echo "test_outerhelioawsom_rundir..." >> test_outerhelioawsom.diff
	$(MAKE) test_outerhelioawsom_rundir
	@echo "test_outerhelioawsom_run..." >> test_outerhelioawsom.diff
	$(MAKE) test_outerhelioawsom_run
	@echo "test_outerhelioawsom_check..." >> test_outerhelioawsom.diff
	$(MAKE) test_outerhelioawsom_check

test_outerhelioawsom_compile:
	./Config.pl -u=OuterHelio -e=OuterHelioAwsom -ng=2 -g=4,4,4
	./Config.pl -default
	$(MAKE) BATSRUS
	make PIDL

test_outerhelioawsom_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${TESTDIR} COMPONENT=OH STANDALONE=YES GMDIR=`pwd`
	cd ${TESTDIR}; cp Param/OUTERHELIO/PARAM.in.awsom ./PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_outerhelioawsom_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -cat -replace RESULTS

test_outerhelioawsom_check:
	-@(${DIFFNUM} -r=3e-5 -a=1e-29 -t \
                ${TESTDIR}/RESULTS/OH/log_n000010.log \
                Param/OUTERHELIO/TestOutput/log_n000010_awsom.log \
                > test_outerhelioawsom.diff)
	ls -l test_outerhelioawsom.diff

test_outerhelioawsom_restart:
	@echo "test_outerhelioawsom_restart_compile..." > test_outerhelioawsom_restart.diff
	$(MAKE) test_outerhelioawsom_restart_compile
	@echo "test_outerhelioawsom_restart_run..." >> test_outerhelioawsom_restart.diff
	$(MAKE) test_outerhelioawsom_restart_run
	@echo "test_outerhelioawsom_restart_check..." >> test_outerhelioawsom_restart.diff
	$(MAKE) test_outerhelioawsom_restart_check

test_outerhelioawsom_restart_compile:
	./Config.pl -u=OuterHelio -e=OuterHelioAwsomPuiBin -ng=2 -g=4,4,4 -nPui=10
	./Config.pl -default
	$(MAKE) BATSRUS
	make PIDL
	
test_outerhelioawsom_restart_run:
	cd ${TESTDIR}; ./Restart.pl -i RESULTS/RESTART
	cd ${TESTDIR}; cp Param/OUTERHELIO/PARAM.in.awsom.restart ./PARAM.in	
	-./TestParam.pl -F ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -cat -replace RESULTS_restart

test_outerhelioawsom_restart_check:
	-@(${DIFFNUM} -r=3e-5 -a=1e-29 -t \
                ${TESTDIR}/RESULTS_restart/OH/log_n000040.log \
                Param/OUTERHELIO/TestOutput/log_n000040_awsom_restart.log \
                > test_outerhelioawsom_restart.diff)
	ls -l test_outerhelioawsom_restart.diff

### OUTER HELIOSPHERE TEST WITH PUI ###

test_outerheliopui:
	@echo "test_outerheliopui_compile..." > test_outerheliopui.diff
	$(MAKE) test_outerheliopui_compile
	@echo "test_outerheliopui_rundir..." >> test_outerheliopui.diff
	$(MAKE) test_outerheliopui_rundir
	@echo "test_outerheliopui_run..." >> test_outerheliopui.diff
	$(MAKE) test_outerheliopui_run
	@echo "test_outerheliopui_check..." >> test_outerheliopui.diff
	$(MAKE) test_outerheliopui_check

test_outerheliopui_compile:
	./Config.pl -u=OuterHelio -e=OuterHelioPUIPe -ng=2 -g=4,4,4
	./Config.pl -default
	$(MAKE) BATSRUS
	make PIDL

test_outerheliopui_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${TESTDIR} COMPONENT=OH STANDALONE=YES GMDIR=`pwd`
	cd ${TESTDIR}; cp Param/OUTERHELIO/PARAM.in.pui ./PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_outerheliopui_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog_start
	cd ${TESTDIR}; ./Restart.pl
	cd ${TESTDIR}; mv PARAM.in PARAM.in.start; rm -f PARAM.in_orig_
	cd ${TESTDIR}; cp Param/OUTERHELIO/PARAM.in.pui.restart ./PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -cat -replace RESULTS/

test_outerheliopui_check:
	-@(${DIFFNUM} -t -r=1e-5 \
		${TESTDIR}/RESULTS/OH/log_n000010.log \
		Param/OUTERHELIO/TestOutput/log_n000010_pui.log \
		> test_outerheliopui.diff)
	ls -l test_outerheliopui.diff

### 1D OUTER HELIOSPHERE TEST WITH PUI ###

test_outerheliopui_1d:
	@echo "test_outerheliopui_1d_compile..." > test_outerheliopui_1d.diff
	$(MAKE) test_outerheliopui_1d_compile
	@echo "test_outerheliopui_1d_rundir..." >> test_outerheliopui_1d.diff
	$(MAKE) test_outerheliopui_1d_rundir
	@echo "test_outerheliopui_1d_run..." >> test_outerheliopui_1d.diff
	$(MAKE) test_outerheliopui_1d_run
	@echo "test_outerheliopui_1d_check..." >> test_outerheliopui_1d.diff
	$(MAKE) test_outerheliopui_1d_check

test_outerheliopui_1d_compile:
	./Config.pl -default ${OPENMP} -u=OuterHelio -e=OuterHelioPUI -ng=2 -g=4,4,4
	$(MAKE) BATSRUS
	make PIDL

test_outerheliopui_1d_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${TESTDIR} COMPONENT=OH STANDALONE=YES GMDIR=`pwd`
	cd ${TESTDIR}; cp Param/OUTERHELIO/PARAM.in.pui1d ./PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_outerheliopui_1d_run:
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS

test_outerheliopui_1d_check:
	-@(${DIFFNUM} -t -r=1e-5 \
                ${TESTDIR}/RESULTS/OH/log_n000000.log \
                Param/OUTERHELIO/TestOutput/log_n000000_pui1d.log \
                > test_outerheliopui_1d.diff)
	ls -l test_outerheliopui_1d.diff

### TESTS FOR MODELING TITAN ###

test_titan:
	@($(MAKE) test_titan_start)
	@($(MAKE) test_titan_restart)

test_titan_start:
	@echo "test_titan_compile..." > test_titan.diff
	$(MAKE) test_titan_compile
	@echo "test_titan_rundir..." >> test_titan.diff
	$(MAKE) test_titan_rundir
	@echo "test_titan_run..." >> test_titan.diff
	$(MAKE) test_titan_run
	@echo "test_titan_check..." >> test_titan.diff
	$(MAKE) test_titan_check

test_titan_compile:
	./Config.pl -default ${OPENMP} -u=Titan -e=MhdTitan -ng=2 -g=6,6,6
	$(MAKE) BATSRUS
	make PIDL

test_titan_rundir: test_rundir
	cd ${TESTDIR}; \
		cp Param/TITAN/PARAM.in .; \
		tar xzf Param/TITAN/TitanInput.tgz
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_titan_run:
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS

test_titan_check:
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-15 \
		${TESTDIR}/RESULTS/GM/log_n000001.log \
		Param/TITAN/TestOutput/log_n000001.log \
		> test_titan.diff)
	ls -l test_titan.diff

test_titan_restart:
	@echo "test_titan_restart_save..." > test_titan_restart.diff
	$(MAKE) test_titan_restart_save
	@echo "test_titan_restart_read..." >> test_titan_restart.diff
	$(MAKE) test_titan_restart_read
	@echo "test_titan_restart_check..." >> test_titan_restart.diff
	$(MAKE) test_titan_restart_check

test_titan_restart_save:
	cd ${TESTDIR}; cp Param/TITAN/PARAM.in.restartsave PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS/RestartSave

test_titan_restart_read:
	cd ${TESTDIR}; cp Param/TITAN/PARAM.in.restartread PARAM.in
	cd ${TESTDIR}; ./Restart.pl -i RESULTS/RestartSave/RESTART
	-./TestParam.pl -F ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS/RestartRead

test_titan_restart_check:
	cd ${TESTDIR}/RESULTS; \
		cp RestartSave/GM/log_n000001.log log_all.log; \
		tail -25 RestartRead/GM/log_n000026.log >> log_all.log
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-15 \
		${TESTDIR}/RESULTS/log_all.log \
		Param/TITAN/TestOutput/log_n000001.log \
		> test_titan_restart.diff)
	ls -l test_titan*.diff

### TESTS FOR MODELING MARS ###

test_mars:
	@($(MAKE) test_mars_start)
	@($(MAKE) test_mars_restart)

test_mars_start:
	@echo "test_mars_compile..." > test_mars.diff
	$(MAKE) test_mars_compile
	@echo "test_mars_rundir..." >> test_mars.diff
	$(MAKE) test_mars_rundir
	@echo "test_mars_run..." >> test_mars.diff
	$(MAKE) test_mars_run
	@echo "test_mars_check..." >> test_mars.diff
	$(MAKE) test_mars_check

test_mars_compile:
	./Config.pl -default ${OPENMP} -u=Mars -e=MhdMars -ng=2 -g=6,6,6
	$(MAKE) BATSRUS
	make PIDL

test_mars_rundir: test_rundir
	cd ${TESTDIR}; cp Param/MARS/PARAM.in .
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_mars_run:
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS

test_mars_check:
	-@(${DIFFNUM} -b -r=1e-5 \
		${TESTDIR}/RESULTS/GM/log_n000001.log \
		Param/MARS/TestOutput/log_n000001.log \
		> test_mars.diff)
	ls -l test_mars.diff

test_mars_restart:
	@echo "test_mars_restart_save..." > test_mars_restart.diff
	$(MAKE) test_mars_restart_save
	@echo "test_mars_restart_read..." >> test_mars_restart.diff
	$(MAKE) test_mars_restart_read
	@echo "test_mars_restart_check..." >> test_mars_restart.diff
	$(MAKE) test_mars_restart_check

test_mars_restart_save:
	cd ${TESTDIR}; cp Param/MARS/PARAM.in.restartsave PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; sleep 1; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS/RestartSave

test_mars_restart_read:
	cd ${TESTDIR}; cp Param/MARS/PARAM.in.restartread PARAM.in
	cd ${TESTDIR}; ./Restart.pl -i RESULTS/RestartSave/RESTART
	-./TestParam.pl -F ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; sleep 1; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS/RestartRead

test_mars_restart_check:
	cd ${TESTDIR}/RESULTS; \
		cp RestartSave/GM/log_n000001.log log_all.log; \
		tail -25 RestartRead/GM/log_n000026.log >> log_all.log
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-15 \
		${TESTDIR}/RESULTS/log_all.log \
		Param/MARS/TestOutput/log_n000001.log \
		> test_mars_restart.diff)
	ls -l test_mars*.diff


# Time-accurate Mars test for CCMC

test_ccmc_mars:
	@echo "test_ccmc_mars_compile..." > test_ccmc_mars.diff
	$(MAKE) test_ccmc_mars_compile
	@echo "test_ccmc_mars_rundir..." >> test_ccmc_mars.diff
	$(MAKE) test_ccmc_mars_rundir
	@echo "test_ccmc_mars_run..." >> test_ccmc_mars.diff
	$(MAKE) test_ccmc_mars_run
	@echo "test_ccmc_mars_check..." >> test_ccmc_mars.diff
	$(MAKE) test_ccmc_mars_check

test_ccmc_mars_compile:
	./Config.pl -default -u=Mars -e=MhdMars -ng=2 -g=6,6,6
	$(MAKE) BATSRUS
	make PIDL

test_ccmc_mars_rundir: test_rundir
	cd ${TESTDIR}; cp Param/MARS/PARAM.in.ta PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_ccmc_mars_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS

test_ccmc_mars_check:
	-@(${DIFFNUM} -b -r=1e-5 \
		${TESTDIR}/RESULTS/GM/log_n000[12]*.log \
		Param/MARS/TestOutput/log_ta.log \
		> test_ccmc_mars.diff)
	ls -l test_ccmc_mars.diff

### TESTS FOR MODELING MARSFLUIDS ###

test_marsfluids:
	@($(MAKE) test_marsfluids_start)
	@($(MAKE) test_marsfluids_restart)

test_marsfluids_start:
	@echo "test_marsfluids_compile..." > test_marsfluids.diff
	$(MAKE) test_marsfluids_compile
	@echo "test_marsfluids_rundir..." >> test_marsfluids.diff
	$(MAKE) test_marsfluids_rundir
	@echo "test_marsfluids_run..." >> test_marsfluids.diff
	$(MAKE) test_marsfluids_run
	@echo "test_marsfluids_check..." >> test_marsfluids.diff
	$(MAKE) test_marsfluids_check

test_marsfluids_compile:
	./Config.pl -default -u=MarsFluids -e=MarsFluids -ng=2 -g=6,6,6
	$(MAKE) BATSRUS
	make PIDL

test_marsfluids_rundir: test_rundir
	cd ${TESTDIR}; cp Param/MARSFLUIDS/PARAM.in .
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_marsfluids_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS

test_marsfluids_check:
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-15 \
		${TESTDIR}/RESULTS/GM/log_n000001.log \
		Param/MARSFLUIDS/TestOutput/log_n000001.log \
		> test_marsfluids.diff)
	ls -l test_marsfluids.diff

test_marsfluids_restart:
	@echo "test_marsfluids_restart_save..." > test_marsfluids_restart.diff
	$(MAKE) test_marsfluids_restart_save
	@echo "test_marsfluids_restart_read..." >> test_marsfluids_restart.diff
	$(MAKE) test_marsfluids_restart_read
	@echo "test_marsfluids_restart_check..." >>test_marsfluids_restart.diff
	$(MAKE) test_marsfluids_restart_check

test_marsfluids_restart_save:
	cd ${TESTDIR}; cp Param/MARSFLUIDS/PARAM.in.restartsave PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; sleep 1; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS/RestartSave

test_marsfluids_restart_read:
	cd ${TESTDIR}; cp Param/MARSFLUIDS/PARAM.in.restartread PARAM.in
	cd ${TESTDIR}; ./Restart.pl -i RESULTS/RestartSave/RESTART
	-./TestParam.pl -F ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; sleep 1; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS/RestartRead

test_marsfluids_restart_check:
	cd ${TESTDIR}/RESULTS; \
		cp RestartSave/GM/log_n000001.log log_all.log; \
		tail -10 RestartRead/GM/log_n000011.log >> log_all.log
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-15 \
		${TESTDIR}/RESULTS/log_all.log \
		Param/MARSFLUIDS/TestOutput/log_n000001.log \
		> test_marsfluids_restart.diff)
	ls -l test_marsfluids*.diff


### TESTS FOR MODELING VENUS ###

test_venus:
	@($(MAKE) test_venus_start)
	@($(MAKE) test_venus_restart)

test_venus_start:
	@echo "test_venus_compile..." > test_venus.diff
	$(MAKE) test_venus_compile
	@echo "test_venus_rundir..." >> test_venus.diff
	$(MAKE) test_venus_rundir
	@echo "test_venus_run..." >> test_venus.diff
	$(MAKE) test_venus_run
	@echo "test_venus_check..." >> test_venus.diff
	$(MAKE) test_venus_check

test_venus_compile:
	./Config.pl -default ${OPENMP} -u=Venus -e=MhdMars -ng=2 -g=6,6,6
	$(MAKE) BATSRUS
	make PIDL

test_venus_rundir: test_rundir
	cd ${TESTDIR}; cp Param/VENUS/PARAM.in .
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_venus_run:
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS

test_venus_check:
	-@(${DIFFNUM} -b -r=1e-5 -a=1e-17 \
		${TESTDIR}/RESULTS/GM/log_n000001.log \
		Param/VENUS/TestOutput/log_n000001.log \
		> test_venus.diff)
	ls -l test_venus.diff

test_venus_restart:
	@echo "test_venus_restart_save..." > test_venus_restart.diff
	$(MAKE) test_venus_restart_save
	@echo "test_venus_restart_read..." >> test_venus_restart.diff
	$(MAKE) test_venus_restart_read
	@echo "test_venus_restart_check..." >> test_venus_restart.diff
	$(MAKE) test_venus_restart_check

test_venus_restart_save:
	cd ${TESTDIR}; cp Param/VENUS/PARAM.in.restartsave PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS/RestartSave

test_venus_restart_read:
	cd ${TESTDIR}; cp Param/VENUS/PARAM.in.restartread PARAM.in
	cd ${TESTDIR}; ./Restart.pl -i RESULTS/RestartSave/RESTART
	-./TestParam.pl -F ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS/RestartRead

test_venus_restart_check:
	cd ${TESTDIR}/RESULTS; \
		cp RestartSave/GM/log_n000001.log log_all.log; \
		tail -25 RestartRead/GM/log_n000026.log >> log_all.log
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-15 \
		${TESTDIR}/RESULTS/log_all.log \
		Param/VENUS/TestOutput/log_n000001.log \
		> test_venus_restart.diff)
	ls -l test_venus*.diff

### TESTS FOR MODELING SATURN ###

test_saturn:
	@echo "test_saturn_compile..." > test_saturn.diff
	$(MAKE) test_saturn_compile
	@echo "test_saturn_rundir..." >> test_saturn.diff
	$(MAKE) test_saturn_rundir
	@echo "test_saturn_run..." >> test_saturn.diff
	$(MAKE) test_saturn_run
	@echo "test_saturn_check..." >> test_saturn.diff
	$(MAKE) test_saturn_check

test_saturn_compile:
	./Config.pl -default ${OPENMP} -u=Saturn -e=MhdHyp -ng=2 -g=8,8,8
	$(MAKE) BATSRUS
	make PIDL

test_saturn_rundir: test_rundir
	cd ${TESTDIR}; cp Param/SATURN/PARAM.in .
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_saturn_run:
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS

test_saturn_check:
	-@(${DIFFNUM} -b -r=1e-5 -a=1e-17 \
		${TESTDIR}/RESULTS/GM/log_n000001.log \
		Param/SATURN/TestOutput/log_n000001.log \
		> test_saturn.diff)
	ls -l test_saturn.diff

### TESTS FOR MODELING JUPITER ###

test_jupiter:
	@echo "test_jupiter_compile..." > test_jupiter.diff
	$(MAKE) test_jupiter_compile
	@echo "test_jupiter_rundir..." >> test_jupiter.diff
	$(MAKE) test_jupiter_rundir
	@echo "test_jupiter_run..." >> test_jupiter.diff
	$(MAKE) test_jupiter_run
	@echo "test_jupiter_check..." >> test_jupiter.diff
	$(MAKE) test_jupiter_check

test_jupiter_compile:
	./Config.pl -default ${OPENMP} -u=Jupiter -e=Mhd -ng=2 -g=8,8,8
	$(MAKE) BATSRUS
	make PIDL

test_jupiter_rundir: test_rundir
	cd ${TESTDIR}; cp Param/JUPITER/PARAM.in .
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_jupiter_run:
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS

test_jupiter_check:
	-@(${DIFFNUM} -b -r=1e-5 -a=1e-16 \
		${TESTDIR}/RESULTS/GM/log_n000001.log \
		Param/JUPITER/TestOutput/log_n000001.log \
		> test_jupiter.diff)
	ls -l test_jupiter.diff


### TESTS FOR MODELING MERCURY ###

test_mercurysph:
	@echo "test_mercurysph_compile..." > test_mercurysph.diff
	$(MAKE) test_mercurysph_compile
	@echo "test_mercurysph_rundir..." >> test_mercurysph.diff
	$(MAKE) test_mercurysph_rundir
	@echo "test_mercurysph_run..." >> test_mercurysph.diff
	$(MAKE) test_mercurysph_run
	@echo "test_mercurysph_check..." >> test_mercurysph.diff
	$(MAKE) test_mercurysph_check

test_mercurysph_compile:
	./Config.pl -default -u=Mercury -e=MhdPe -ng=2 -g=8,8,8
	$(MAKE) BATSRUS
	make PIDL

test_mercurysph_rundir: test_rundir
	cd ${TESTDIR}; cp Param/MERCURY/PARAM.in .
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_mercurysph_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -g -M -replace RESULTS

# Sort the files by numerical values of the first three columns (coordinates)
test_mercurysph_check:
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-6 \
		${TESTDIR}/RESULTS/GM/log_n000000.log \
		Param/MERCURY/TestOutput/REFlog_n000000.log \
		> test_mercurysph.diff)
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-6 -p="sort -k1 -k2 -k3 -g | grep -v AUXDATA" \
		${TESTDIR}/RESULTS/GM/3d__var_2_n00000100.dat.gz \
		data/MERCURY/REF3d__var_2_n0000100.dat.gz \
		>> test_mercurysph.diff)
	ls -l test_mercurysph.diff

### TESTS FOR MODELING GANYMEDE ###

test_ganymede:
	@echo "test_ganymede_compile..." > test_ganymede.diff
	$(MAKE) test_ganymede_compile
	@echo "test_ganymede_rundir..." >> test_ganymede.diff
	$(MAKE) test_ganymede_rundir
	@echo "test_ganymede_run..." >> test_ganymede.diff
	$(MAKE) test_ganymede_run
	@echo "test_ganymede_check..." >> test_ganymede.diff
	$(MAKE) test_ganymede_check

# Fails on Pleiades with OpenMP
test_ganymede_compile:
	./Config.pl -default -u=Ganymede -e=MhdHypPe -ng=2 -g=8,8,8
	$(MAKE) BATSRUS
	make PIDL

test_ganymede_rundir: test_rundir
	cd ${TESTDIR}; cp Param/GANYMEDE/PARAM.in .
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_ganymede_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}/GM; ./pTEC g
	cd ${TESTDIR}; ./PostProc.pl -g -M -replace RESULTS

test_ganymede_check:
	-@(${DIFFNUM} -b -r=1e-5 -a=1e-6 \
	   ${TESTDIR}/RESULTS/GM/log_n000001.log \
	   Param/GANYMEDE/TestOutput/REFlog_n000001.log \
		> test_ganymede.diff)
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-6\
	   ${TESTDIR}/RESULTS/GM/y=0_var_1_n00000005.out \
	   data/GANYMEDE/REFy=0.out.gz \
	   	>> test_ganymede.diff)
	ls -l test_ganymede.diff

### TESTS FOR MODELING COMET6SP ###

test_comet:
	@echo "test_comet_compile..." > test_comet.diff
	$(MAKE) test_comet_compile
	@echo "test_comet_rundir..." >> test_comet.diff
	$(MAKE) test_comet_rundir
	@echo "test_comet_run..." >> test_comet.diff
	$(MAKE) test_comet_run
	@echo "test_comet_check..." >> test_comet.diff
	$(MAKE) test_comet_check

test_comet_compile:
	./Config.pl -default -u=Comet6Sp -e=MhdComet -ng=2 -g=8,8,8
	$(MAKE) BATSRUS
	make PIDL

test_comet_rundir: test_rundir
	cd ${TESTDIR}; cp Param/COMET/PARAM.in .
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_comet_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS

test_comet_check:
	-@(${DIFFNUM} -b -r=1e-5 -a=1e-10 \
		${TESTDIR}/RESULTS/GM/log_n000001.log \
		Param/COMET/TestOutput/log_n000001.log \
		> test_comet.diff)
	ls -l test_comet.diff

### TEST FOR COMET3FLUIDSPE ###

test_cometfluids:
	@($(MAKE) test_cometfluids_start)
	@($(MAKE) test_cometfluids_restart)

test_cometfluids_start:
	@echo "test_cometfluids_compile..." > test_cometfluids.diff
	$(MAKE) test_cometfluids_compile
	@echo "test_cometfluids_rundir..." >> test_cometfluids.diff
	$(MAKE) test_cometfluids_rundir
	@echo "test_cometfluids_run..." >> test_cometfluids.diff
	$(MAKE) test_cometfluids_run
	@echo "test_cometfluids_check..." >> test_cometfluids.diff
	$(MAKE) test_cometfluids_check

# OpenMP run fails for NAGFOR on 4 cores * 2 threads
test_cometfluids_compile:
	./Config.pl -u=Comet3FluidsPe -e=Comet3FluidsPe -ng=2 -g=8,8,8
	./Config.pl -default 
	$(MAKE) BATSRUS
	make PIDL

test_cometfluids_rundir: test_rundir
	cd ${TESTDIR}; cp Param/COMET3FLUIDSPE/PARAM.in .
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_cometfluids_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS

test_cometfluids_check:
	-@(${DIFFNUM} -t -r=8e-5 \
		${TESTDIR}/RESULTS/GM/log_n000060.log \
		Param/COMET3FLUIDSPE/TestOutput/log_n000060.log \
		> test_cometfluids.diff)
	ls -l test_cometfluids.diff

test_cometfluids_restart:
	@echo "test_cometfluids_restart_save..." > test_cometfluids_restart.diff
	$(MAKE) test_cometfluids_restart_save
	@echo "test_cometfluids_restart_read..." >> test_cometfluids_restart.diff
	$(MAKE) test_cometfluids_restart_read
	@echo "test_cometfluids_restart_check..." >>test_cometfluids_restart.diff
	$(MAKE) test_cometfluids_restart_check

test_cometfluids_restart_save:
	cd ${TESTDIR}; cp Param/COMET3FLUIDSPE/PARAM.in.restartsave PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; sleep 1; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS/RestartSave

test_cometfluids_restart_read:
	cd ${TESTDIR}; cp Param/COMET3FLUIDSPE/PARAM.in.restartread PARAM.in
	cd ${TESTDIR}; ./Restart.pl -i RESULTS/RestartSave/RESTART
	-./TestParam.pl -F ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; sleep 1; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS/RestartRead

test_cometfluids_restart_check:
	cd ${TESTDIR}/RESULTS; \
		cp RestartRead/GM/log_n000060.log log_test.log
	-@(${DIFFNUM} -t -r=8e-5 \
		${TESTDIR}/RESULTS/log_test.log \
		Param/COMET3FLUIDSPE/TestOutput/log_n000060.log \
		> test_cometfluids_restart.diff)
	ls -l test_cometfluids*.diff

### TESTS FOR MODELING EARTH WITH CARTESIAN GRID ###

test_earth:
	@echo "test_earth_compile..." > test_earth_gpu.diff
	$(MAKE) test_earth_compile
	@echo "test_earth_rundir..." >> test_earth_gpu.diff
	$(MAKE) test_earth_rundir
	@echo "test_earth_run..." >> test_earth_gpu.diff
	$(MAKE) test_earth_run
	@echo "test_earth_check..." >> test_earth_gpu.diff
	$(MAKE) test_earth_check

test_earth_compile:
	./Config.pl -default ${OPENACC}
	./Config.pl -e=Mhd -u=Default -ng=2 -g=10,10,10
	./Config.pl -opt=Param/EARTH/PARAM.in.gpu
	${MAKE} BATSRUS
	make PIDL

test_earth_rundir: test_rundir
	cd ${TESTDIR}; \
		cp Param/EARTH/PARAM.in.gpu PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_earth_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m -replace RESULTS

test_earth_check:
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-13 \
		${TESTDIR}/RESULTS/GM/log*.log \
		Param/EARTH/TestOutput/earth_cartesian_ref.log \
		> test_earth_gpu.diff)
	-@(${DIFFNUM} -t -r=1e-8 -a=1e-13 \
		${TESTDIR}/RESULTS/GM/y=0_var_2_t00000001*.out \
		Param/EARTH/TestOutput/earth_cartesian_ref.out \
		>> test_earth_gpu.diff)
	-@(${DIFFNUM} -t -r=2e-4 -a=1e-4 \
		${TESTDIR}/RESULTS/GM/mag_grid_global_n00000025.out \
		Param/EARTH/TestOutput/earth_cartesian_mag_grid.out.gz \
		>> test_earth_gpu.diff)
	ls -l test_earth_gpu.diff

########## Large (same as SWPC V2) test

test_earth_large_gpu:
	@echo "test_earth_large_gpu_compile..." > test_earth_large_gpu.diff
	$(MAKE) test_earth_large_gpu_compile
	@echo "test_earth_large_gpu_rundir..." >> test_earth_large_gpu.diff
	$(MAKE) test_earth_large_gpu_rundir
	@echo "test_earth_large_gpu_run..." >> test_earth_large_gpu.diff
	$(MAKE) test_earth_large_gpu_run
	@echo "test_earth_large_gpu_check..." >> test_earth_large_gpu.diff
	$(MAKE) test_earth_large_gpu_check

test_earth_large_gpu_compile:
	./Config.pl -default ${OPENACC}
	./Config.pl -e=Mhd -u=Default -ng=2 -g=8,8,8
	./Config.pl -opt=Param/EARTH/PARAM.in.large.gpu
	${MAKE} BATSRUS
	make PIDL

test_earth_large_gpu_rundir: test_rundir
	cd ${TESTDIR}; cp Param/EARTH/PARAM.in.large.gpu PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_earth_large_gpu_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m -replace RESULTS

test_earth_large_gpu_check:
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-13 \
		${TESTDIR}/RESULTS/GM/log*.log \
		Param/EARTH/TestOutput/earth_large_ref.log \
		> test_earth_large_gpu.diff)
	ls -l test_earth_large_gpu.diff

### TESTS FOR MODELING EARTH WITH SPHERICAL GRID ###

test_earthsph:
	-@($(MAKE) test_earthsph_start)

test_earthsph_start:
	@echo "test_earthsph_compile..." > test_earthsph.diff
	$(MAKE) test_earthsph_compile
	@echo "test_earthsph_rundir..." >> test_earthsph.diff
	$(MAKE) test_earthsph_rundir
	@echo "test_earthsph_run..." >> test_earthsph.diff
	$(MAKE) test_earthsph_run
	@echo "test_earthsph_check..." >> test_earthsph.diff
	$(MAKE) test_earthsph_check

# Fails with OpenMP on Pleiades
test_earthsph_compile:
	./Config.pl -default -e=Mhd -u=Default -ng=2 -g=8,8,8
	${MAKE} BATSRUS
	make PIDL

test_earthsph_rundir: test_rundir
	cd ${TESTDIR}; \
		cp Param/EARTH/PARAM.in.spherical PARAM.in; \
		cp Param/EARTH/imf19980504.dat .
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_earthsph_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS

test_earthsph_check:
	-@(${DIFFNUM} -b -r=1e-5 \
		${TESTDIR}/RESULTS/GM/log_n000001.log \
		Param/EARTH/TestOutput/SPHlog_n000001.log \
		> test_earthsph.diff)
	ls -l test_earthsph.diff

### TESTS FOR AMR GRID ###

test_amr:
	@echo "test_amr_compile..." > test_amr.diff
	$(MAKE) test_amr_compile
	@echo "test_amr_rundir..." >> test_amr.diff
	$(MAKE) test_amr_rundir
	@echo "test_amr_run..." >> test_amr.diff
	$(MAKE) test_amr_run
	@echo "test_amr_check..." >> test_amr.diff
	$(MAKE) test_amr_check

test_amr_compile:
	./Config.pl -default ${OPENMP} -e=Mhd -u=Default -ng=2 -g=4,4,4
	$(MAKE) BATSRUS
	make PIDL

test_amr_rundir: test_rundir
	cd ${TESTDIR}; cp Param/AMR/PARAM.in .
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_amr_run:
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS

test_amr_check:
	-@(${DIFFNUM} -b -a=1e-8 -r=1e-12 \
		${TESTDIR}/RESULTS/GM/log_n000000.log \
		Param/AMR/TestOutput/log.log \
		> test_amr.diff)
	ls -l test_amr.diff

### TESTS FOR SPHERICAL AMR GRID ###

test_amrsph:
	@echo "test_amrsph_compile..." > test_amrsph.diff
	$(MAKE) test_amrsph_compile
	@echo "test_amrsph_rundir..." >> test_amrsph.diff
	$(MAKE) test_amrsph_rundir
	@echo "test_amrsph_run..." >> test_amrsph.diff
	$(MAKE) test_amrsph_run
	@echo "test_amrsph_check..." >> test_amrsph.diff
	$(MAKE) test_amrsph_check

test_amrsph_compile:
	./Config.pl -default ${OPENMP} -e=Mhd -u=Default -ng=2 -g=4,4,4
	$(MAKE) BATSRUS
	make PIDL

test_amrsph_rundir: test_rundir
	cd ${TESTDIR}; cp Param/AMR/PARAM.in.sph PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_amrsph_run:
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS

test_amrsph_check:
	-@(${DIFFNUM} -b -a=1e-8 -r=1e-12\
		${TESTDIR}/RESULTS/GM/log_n000000.log \
		Param/AMR/TestOutput/log_sph.log \
		> test_amrsph.diff)
	ls -l test_amrsph.diff

### TESTS FOR CORRECT 2 BODY PLOT FILES ###

test_2bodyplot:
	@echo "test_2bodyplot_compile..." > test_2bodyplot.diff
	$(MAKE) test_2bodyplot_compile
	@echo "test_2bodyplot_rundir..." >> test_2bodyplot.diff
	$(MAKE) test_2bodyplot_rundir
	@echo "test_2bodyplot_run..." >> test_2bodyplot.diff
	$(MAKE) test_2bodyplot_run
	@echo "test_2bodyplot_check..." >> test_2bodyplot.diff
	$(MAKE) test_2bodyplot_check

test_2bodyplot_compile:
	./Config.pl -default ${OPENMP} -e=Mhd -u=Default -ng=2 -g=8,8,8
	$(MAKE) BATSRUS
	make PIDL

test_2bodyplot_rundir: test_rundir
	cd ${TESTDIR}; cp Param/2BODYPLOT/PARAM.in PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_2bodyplot_run:
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}/GM; ./pTEC g
	cd ${TESTDIR}; ./PostProc.pl -g -M -replace RESULTS

# Sort the files by numerical values of the first three columns (coordinates)
test_2bodyplot_check:
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-6 \
		${TESTDIR}/RESULTS/GM/log_n000001.log \
		Param/2BODYPLOT/TestOutput/REFlog_n000001.log \
		> test_2bodyplot.diff)
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-6 \
		${TESTDIR}/RESULTS/GM/y=0_var_*9_*.out \
		Param/2BODYPLOT/TestOutput/REFy*.out.gz \
		>> test_2bodyplot.diff)
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-6 -p='sort -k1 -k2 -k3 -g | grep -v AUXDATA' \
		${TESTDIR}/RESULTS/GM/y=0_ful_*9_*.dat.gz \
		Param/2BODYPLOT/TestOutput/REFy*.dat.gz \
		>> test_2bodyplot.diff)
	ls -l test_2bodyplot.diff

### TESTS FOR MODELING MOON IMPACT###

test_moonimpact:
	@echo "test_moonimpact_compile..." > test_moonimpact.diff
	$(MAKE) test_moonimpact_compile
	@echo "test_moonimpact_rundir..." >> test_moonimpact.diff
	$(MAKE) test_moonimpact_rundir
	@echo "test_moonimpact_run..." >> test_moonimpact.diff
	$(MAKE) test_moonimpact_run
	@echo "test_moonimpact_check..." >> test_moonimpact.diff
	$(MAKE) test_moonimpact_check

test_moonimpact_compile:
	./Config.pl -default -u=MoonImpact -e=MhdHyp -ng=2 -g=6,6,6
	$(MAKE) BATSRUS
	make PIDL

test_moonimpact_rundir: test_rundir
	cd ${TESTDIR}; \
		cp Param/MOONIMPACT/PARAM.in .
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_moonimpact_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS

test_moonimpact_check:
	-@(${DIFFNUM} -t -b -r=1e-5 -a=1e-10 \
		${TESTDIR}/RESULTS/GM/log_n000000.log \
		Param/MOONIMPACT/TestOutput/log_n000000.log \
		> test_moonimpact.diff)
	ls -l test_moonimpact.diff

### ALFVEN WAVE TEST FOR SINGLE FLUID MHD WITH ANISOTROPIC PRESSURE ###

test_anisotropic:
	@echo "test_anisotropic_compile..." > test_anisotropic.diff
	$(MAKE) test_anisotropic_compile
	@echo "test_anisotropic_rundir..." >> test_anisotropic.diff
	$(MAKE) test_anisotropic_rundir
	@echo "test_anisotropic_run..." >> test_anisotropic.diff
	$(MAKE) test_anisotropic_run
	@echo "test_anisotropic_check..." >> test_anisotropic.diff
	$(MAKE) test_anisotropic_check

test_anisotropic_compile:
	./Config.pl -default ${OPENMP} -u=Default -e=MhdPeAniso -f -ng=2 -g=100,2,2
	$(MAKE) BATSRUS
	make PIDL

test_anisotropic_rundir: test_rundir
	cd ${TESTDIR}; cp Param/ANISOPRESSURE/PARAM.in.anisope.fastwave PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_anisotropic_run:
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m -replace RESULT

test_anisotropic_check:
	-@(${DIFFNUM} -t -r=1e-5 -a=1e-12 \
	    ${TESTDIR}/RESULT/GM/1d_*t00.50*.out \
	    Param/ANISOPRESSURE/TestOutput/fast_anisope.out \
	    > test_anisotropic.diff)
	ls -l test_anisotropic.diff

### TEST FOR COMET CG HD RUN ###

test_cometCGhd:
	@echo "test_cometCGhd_compile..." > test_cometCGhd.diff
	$(MAKE) test_cometCGhd_compile
	@echo "test_cometCGhd_rundir..." >> test_cometCGhd.diff
	$(MAKE) test_cometCGhd_rundir
	@echo "test_cometCGhd_run..." >> test_cometCGhd.diff
	$(MAKE) test_cometCGhd_run
	@echo "test_cometCGhd_check..." >> test_cometCGhd.diff
	$(MAKE) test_cometCGhd_check

test_cometCGhd_compile:
	./Config.pl -default ${OPENMP} -u=CometCG -e=Hd -ng=2 -g=8,8,8
	$(MAKE) BATSRUS
	make PIDL

test_cometCGhd_rundir: test_rundir
	cd ${TESTDIR}; cp Param/ROSETTA/PARAM.in.hd.test PARAM.in
	cd ${TESTDIR}; cp Param/ROSETTA/CG_MOC.bdf.gz . 
	cd ${TESTDIR}; gunzip CG_MOC.bdf.gz
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_cometCGhd_run:
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS

test_cometCGhd_check:
	-@(${DIFFNUM} -t -r=8e-5 \
		${TESTDIR}/RESULTS/GM/log_n000000.log \
		Param/ROSETTA/TestOutput/hd_log_n000000.log \
		> test_cometCGhd.diff)
	ls -l test_cometCGhd.diff


### TEST FOR COMET CG ONE NEUTRAL GAS + TWO ION FLUIDS + ELECTRON PRESSURE ###

test_cometCGfluids:
	-@($(MAKE) test_cometCGfluids_start)

test_cometCGfluids_start:
	@echo "test_cometCGfluids_compile..." > test_cometCGfluids.diff
	$(MAKE) test_cometCGfluids_compile
	@echo "test_cometCGfluids_rundir..." >> test_cometCGfluids.diff
	$(MAKE) test_cometCGfluids_rundir
	@echo "test_cometCGfluids_run..." >> test_cometCGfluids.diff
	$(MAKE) test_cometCGfluids_run
	@echo "test_cometCGfluids_check..." >> test_cometCGfluids.diff
	$(MAKE) test_cometCGfluids_check

test_cometCGfluids_compile:
	./Config.pl -u=CometCGfluids -e=CometCG3FluidsPe -ng=2 -g=4,4,4
	./Config.pl -default
	$(MAKE) BATSRUS
	make PIDL

test_cometCGfluids_rundir: test_rundir
	cd ${TESTDIR}; cp Param/ROSETTA/PARAM.in.fluids.all PARAM.in
	cd ${TESTDIR}; cp Param/ROSETTA/CG_MOC.bdf.gz . 
	cd ${TESTDIR}; gunzip CG_MOC.bdf.gz
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_cometCGfluids_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS

test_cometCGfluids_check:
	-@(${DIFFNUM} -t -r=1e-3 -a=1e-12 \
		${TESTDIR}/RESULTS/GM/log_n000000.log \
		Param/ROSETTA/TestOutput/CGfluids_log_n000000.log \
		> test_cometCGfluids.diff)
	ls -l test_cometCGfluids.diff

### TEST FOR EUROPA TWO ION FLUIDS + ELECTRON PRESSURE ###

test_europa2fluidspe:
	@echo "test_europa2fluidspe_compile..." > test_europa2fluidspe.diff
	$(MAKE) test_europa2fluidspe_compile
	@echo "test_europa2fluidspe_rundir..." >> test_europa2fluidspe.diff
	$(MAKE) test_europa2fluidspe_rundir
	@echo "test_europa2fluidspe_run..." >> test_europa2fluidspe.diff
	$(MAKE) test_europa2fluidspe_run
	@echo "test_europa2fluidspe_check..." >> test_europa2fluidspe.diff
	$(MAKE) test_europa2fluidspe_check

test_europa2fluidspe_compile:
	./Config.pl -u=Europa2FluidsPe -e=MhdEuropa2FluidsPe -ng=2 -g=4,4,4
	./Config.pl -default
	$(MAKE) BATSRUS
	make PIDL

test_europa2fluidspe_rundir: test_rundir
	cd ${TESTDIR}; cp Param/EUROPA/PARAM.in.2fluids PARAM.in; \
	   	       cp Param/EUROPA/satellite_e4.dat sate4.dat
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_europa2fluidspe_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -replace RESULTS

test_europa2fluidspe_check:
	-@(${DIFFNUM} -t -r=8e-5 -a=8e-07 \
	    ${TESTDIR}/RESULTS/GM/trj_*_n00000010.sat \
	    Param/EUROPA/TestOutput/trj_satellite_2fpe_e4_n00000010.sat.gz \
		> test_europa2fluidspe.diff)
	ls -l test_europa2fluidspe.diff

### TEST FOR EUROPA THREE ION FLUIDS + ELECTRON PRESSURE ###

test_europa3fluidspe:
	@echo "test_europa3fluidspe_compile..." > test_europa3fluidspe.diff
	$(MAKE) test_europa3fluidspe_compile
	@echo "test_europa3fluidspe_rundir..." >> test_europa3fluidspe.diff
	$(MAKE) test_europa3fluidspe_rundir
	@echo "test_europa3fluidspe_run..." >> test_europa3fluidspe.diff
	$(MAKE) test_europa3fluidspe_run
	@echo "test_europa3fluidspe_check..." >> test_europa3fluidspe.diff
	$(MAKE) test_europa3fluidspe_check

# OpenMP randomly fails for nagfor NP=4 NTHREAD=2
test_europa3fluidspe_compile:
	./Config.pl -u=Europa3FluidsPe -e=MhdEuropa3FluidsPe -ng=2 -g=4,4,4
	./Config.pl -default
	$(MAKE) BATSRUS
	make PIDL

test_europa3fluidspe_rundir: test_rundir
	cd ${TESTDIR}; cp Param/EUROPA/PARAM.in.3fluids PARAM.in; \
	   	       cp Param/EUROPA/satellite_e4.dat sate4.dat
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_europa3fluidspe_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS

test_europa3fluidspe_check:
	-@(${DIFFNUM} -t -r=8e-5 -a=8e-07 \
	    ${TESTDIR}/RESULTS/GM/trj_*_n00000100.sat \
	    Param/EUROPA/TestOutput/trj_satellite_3fpe_e4_n00000100.sat.gz \
		> test_europa3fluidspe.diff)
	ls -l test_europa3fluidspe.diff

### TEST FOR 2D REGIONS ######################################################

test_region2d:
	@echo "test_region2d_compile..." > test_region2d.diff
	$(MAKE) test_region2d_compile
	@echo "test_region2d_rundir..." >> test_region2d.diff
	$(MAKE) test_region2d_rundir
	@echo "test_region2d_run..." >> test_region2d.diff
	$(MAKE) test_region2d_run
	@echo "test_region2d_check..." >> test_region2d.diff
	$(MAKE) test_region2d_check

test_region2d_compile:
	./Config.pl -default ${OPENMP} -e=Mhd -u=Default -ng=2 -g=8,8,1
	$(MAKE) BATSRUS
	make PIDL

test_region2d_rundir: test_rundir
	cd ${TESTDIR}; cp Param/REGION/PARAM.in.2d PARAM.in
	-./TestParam.pl -F -n=1 ${TESTDIR}/PARAM.in >>  test_region2d.diff

test_region2d_run:
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -replace RESULTS/2d
	cd ${TESTDIR}; cp Param/REGION/PARAM.in.cyl PARAM.in
	-./TestParam.pl -F -n=1 ${TESTDIR}/PARAM.in >>  test_region2d.diff
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -replace RESULTS/cyl
	cd ${TESTDIR}; cp Param/REGION/PARAM.in.cyl_lnr PARAM.in
	-./TestParam.pl -F -n=1 ${TESTDIR}/PARAM.in >>  test_region2d.diff
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -replace RESULTS/cyl_lnr

test_region2d_check:
	-@(${DIFFNUM} -b -r=1e-5 -a=1e-6 \
		${TESTDIR}/RESULTS/2d/GM/z*.out \
		Param/REGION/TestOutput/2d.out.gz \
		> test_region2d.diff)
	-@(${DIFFNUM} -b -r=1e-5 -a=1e-6 \
		${TESTDIR}/RESULTS/cyl/GM/z*.out \
		Param/REGION/TestOutput/cyl.out.gz \
		>> test_region2d.diff)
	-@(${DIFFNUM} -b -r=1e-5 -a=1e-6 \
		${TESTDIR}/RESULTS/cyl_lnr/GM/z*.out \
		Param/REGION/TestOutput/cyl_lnr.out.gz \
		>> test_region2d.diff)
	ls -l test_region2d.diff

### TEST FOR FIVEMOMENT ###

test_fivemoment_alfven:
	@echo "test_fivemoment_alfven_compile..." > test_fivemoment_alfven.diff
	$(MAKE) test_fivemoment_alfven_compile
	@echo "test_fivemoment_alfven_rundir..." >> test_fivemoment_alfven.diff
	$(MAKE) test_fivemoment_alfven_rundir
	@echo "test_fivemoment_alfven_run..." >> test_fivemoment_alfven.diff
	$(MAKE) test_fivemoment_alfven_run
	@echo "test_fivemoment_alfven_check..." >> test_fivemoment_alfven.diff
	$(MAKE) test_fivemoment_alfven_check

test_fivemoment_alfven_compile:
	./Config.pl -default ${OPENMP} -u=Default -e=FiveMoment -ng=2 -g=100,1,1
	$(MAKE) BATSRUS
	make PIDL

test_fivemoment_alfven_rundir: test_rundir
	cd ${TESTDIR}; cp Param/FIVEMOMENT/PARAM.in.alfven PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_fivemoment_alfven_run:
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m -replace RESULTS

test_fivemoment_alfven_check:
	-@(${DIFFNUM} -t -r=8e-5 -a=1e-10 \
		${TESTDIR}/RESULTS/GM/1d*t00024640_*out \
		Param/FIVEMOMENT/TestOutput/alfven_ref.out \
		> test_fivemoment_alfven.diff)
	ls -l test_fivemoment_alfven.diff

test_fivemoment_shock:
	@echo "test_fivemoment_shock_compile..." > test_fivemoment_shock.diff
	$(MAKE) test_fivemoment_shock_compile
	@echo "test_fivemoment_shock_rundir..." >> test_fivemoment_shock.diff
	$(MAKE) test_fivemoment_shock_rundir
	@echo "test_fivemoment_shock_run..." >> test_fivemoment_shock.diff
	$(MAKE) test_fivemoment_shock_run
	@echo "test_fivemoment_shock_check..." >> test_fivemoment_shock.diff
	$(MAKE) test_fivemoment_shock_check

test_fivemoment_shock_compile:
	./Config.pl -default -u=Default -e=FiveMoment -ng=2 -g=100,1,1
	$(MAKE) BATSRUS
	make PIDL

test_fivemoment_shock_rundir: test_rundir
	cd ${TESTDIR}; cp Param/FIVEMOMENT/PARAM.in.shock PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_fivemoment_shock_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m -replace RESULTS

test_fivemoment_shock_check:
	-@(${DIFFNUM} -t -r=8e-5 -a=1e-10 \
		${TESTDIR}/RESULTS/GM/1d*t00000002*out \
		Param/FIVEMOMENT/TestOutput/shock_ref.out \
		> test_fivemoment_shock.diff)
	ls -l test_fivemoment_shock.diff

test_fivemoment_langmuir:
	@echo "test_fivemoment_langmuir_compile..." > test_fivemoment_langmuir.diff
	$(MAKE) test_fivemoment_langmuir_compile
	@echo "test_fivemoment_langmuir_rundir..." >> test_fivemoment_langmuir.diff
	$(MAKE) test_fivemoment_langmuir_rundir
	@echo "test_fivemoment_langmuir_run..." >> test_fivemoment_langmuir.diff
	$(MAKE) test_fivemoment_langmuir_run
	@echo "test_fivemoment_langmuir_check..." >> test_fivemoment_langmuir.diff
	$(MAKE) test_fivemoment_langmuir_check

test_fivemoment_langmuir_compile:
	./Config.pl -default ${OPENMP} -u=Default -e=FiveMoment -ng=2 -g=50,50,1
	$(MAKE) BATSRUS
	make PIDL

test_fivemoment_langmuir_rundir: test_rundir
	cd ${TESTDIR}; cp Param/FIVEMOMENT/PARAM.in.langmuir PARAM.in
	-./TestParam.pl -F ${TESTDIR}/PARAM.in

test_fivemoment_langmuir_run:
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m -replace RESULTS

test_fivemoment_langmuir_check:
	-@(${DIFFNUM} -t -r=8e-5 -a=1e-10       \
		${TESTDIR}/RESULTS/GM/1d*t00000001*out       \
		Param/FIVEMOMENT/TestOutput/langmuir_ref.out \
		> test_fivemoment_langmuir.diff)
	ls -l test_fivemoment_langmuir.diff

### TEST FOR L1 to BC PROPAGATION ############################################

test_L1toBC:
	@echo "test_L1toBC_compile..." > test_L1toBC.diff
	$(MAKE) test_L1toBC_compile
	@echo "test_L1toBC_rundir..." >> test_L1toBC.diff
	$(MAKE) test_L1toBC_rundir
	@echo "test_L1toBC_run..." >> test_L1toBC.diff
	$(MAKE) test_L1toBC_run
	@echo "test_L1toBC_check..." >> test_L1toBC.diff
	$(MAKE) test_L1toBC_check

test_L1toBC_compile:
	./Config.pl -default ${OPENMP} -e=Mhd -u=Default -g=8,1,1 -ng=3
	$(MAKE) BATSRUS
	make PIDL

test_L1toBC_rundir: test_rundir
	cd ${TESTDIR}; cp Param/EARTH/PARAM.in.L1toBC PARAM.in
	cd ${TESTDIR}; cp Param/EARTH/imf19980504.dat L1.dat
	-./TestParam.pl -F -n=1 ${TESTDIR}/PARAM.in >>  test_L1toBC.diff

test_L1toBC_run:
	cd ${TESTDIR}; ${OMPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -replace RESULTS

test_L1toBC_check:
	-@(${DIFFNUM} -b \
		${TESTDIR}/RESULTS/GM/log_n000000.log \
		Param/EARTH/TestOutput/L1toBC.log \
		> test_L1toBC.diff)

	ls -l test_L1toBC.diff

### TEST FOR POST-PROCESSING SPECTRUM CODE#####################################

test_spectrum:
	cd ${SHAREDIR}; $(MAKE) LIB
	cd srcPostProc; $(MAKE) test_spectrum

